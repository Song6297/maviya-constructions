<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maviya Constructions - Construction Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header-main">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-hard-hat text-sky-500 text-xl"></i>
                    </div>
                    <h1 class="logo">Maviya Constructions Management</h1>
                </div>
                <nav class="flex items-center gap-2 sm:gap-3">
                    <a href="compare.html" class="btn btn-secondary text-xs sm:text-sm">
                        <i class="fas fa-chart-bar"></i>
                        <span class="hidden sm:inline">Compare</span>
                    </a>
                    <a href="payments.html" class="btn btn-secondary text-xs sm:text-sm">
                        <i class="fas fa-wallet"></i>
                        <span class="hidden sm:inline">Payments</span>
                    </a>
                    <a href="materials.html" class="btn btn-secondary text-xs sm:text-sm">
                        <i class="fas fa-boxes"></i>
                        <span class="hidden sm:inline">Stock</span>
                    </a>
                    <a href="funds.html" class="btn btn-secondary text-xs sm:text-sm">
                        <i class="fas fa-wallet"></i>
                        <span class="hidden sm:inline">Funds</span>
                    </a>
                    <!-- User Menu -->
                    <div class="relative">
                        <button id="userMenuBtn" class="btn btn-header flex items-center gap-2">
                            <i class="fas fa-user-circle text-lg"></i>
                            <span id="userEmailDisplay" class="hidden sm:inline text-xs max-w-[120px] truncate"></span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-slate-200 py-2 z-50">
                            <div class="px-4 py-2 border-b border-slate-200">
                                <p class="text-xs text-slate-500">Signed in as</p>
                                <p id="userEmailFull" class="text-sm font-semibold text-slate-800 truncate"></p>
                            </div>
                            <a href="migrate.html" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition">
                                <i class="fas fa-database text-sky-500"></i>
                                Data Migration
                            </a>
                            <button id="logoutBtn" class="w-full flex items-center gap-3 px-4 py-2 text-sm text-rose-600 hover:bg-rose-50 transition">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </button>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- Alerts Panel -->
        <section id="alertsPanel" class="mb-8 hidden animate-slide-in">
            <div class="card p-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-bell text-sky-500"></i>
                        Alerts & Reminders
                    </h2>
                    <button id="dismissAlerts" class="text-sm text-gray-500 hover:text-gray-700 transition">Dismiss All</button>
                </div>
                <div id="alertsList" class="max-h-64 overflow-y-auto space-y-2"></div>
            </div>
        </section>

        <!-- Metrics -->
        <section class="grid grid-cols-2 lg:grid-cols-5 gap-4 sm:gap-6 mb-8">
            <div class="metric-card animate-fade-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl flex items-center justify-center">
                        <i class="fas fa-folder text-blue-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-slate-600 text-sm font-medium">Total Projects</p>
                <p class="text-3xl font-bold text-slate-800" id="totalProjects">0</p>
            </div>
            <div class="metric-card animate-fade-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-sky-100 to-sky-200 rounded-xl flex items-center justify-center">
                        <i class="fas fa-hammer text-sky-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-slate-600 text-sm font-medium">Active</p>
                <p class="text-3xl font-bold text-sky-600" id="activeProjects">0</p>
            </div>
            <div class="metric-card animate-fade-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-100 to-green-200 rounded-xl flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-slate-600 text-sm font-medium">Completed</p>
                <p class="text-3xl font-bold text-emerald-600" id="completedProjects">0</p>
            </div>
            <div class="metric-card animate-fade-in" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-red-100 to-red-200 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-red-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-slate-600 text-sm font-medium">Delayed</p>
                <p class="text-3xl font-bold text-rose-600" id="delayedProjects">0</p>
            </div>
            <div class="metric-card animate-fade-in" style="animation-delay: 0.5s">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl flex items-center justify-center">
                        <i class="fas fa-rupee-sign text-purple-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-slate-600 text-sm font-medium">Pending Payments</p>
                <p class="text-2xl font-bold text-violet-600" id="pendingPayments">₹0</p>
            </div>
        </section>

        <!-- Projects Section -->
        <section class="card animate-scale-in">
            <div class="p-5 sm:p-6 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-list-check text-sky-500"></i>
                        Projects
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <select id="statusFilter" class="form-input text-sm">
                            <option value="all">All Status</option>
                            <option value="Planning">Planning</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <button id="addProjectBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            New Project
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="projectsContainer" class="p-5 sm:p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8"></div>
            
            <div id="emptyState" class="empty-state hidden">
                <i class="fas fa-folder-open"></i>
                <p class="text-lg font-medium">No projects yet</p>
                <p class="text-sm mt-2">Create your first project to get started!</p>
            </div>
        </section>
    </main>

    <!-- Add/Edit Project Modal -->
    <div id="projectModal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-content w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="modalTitle" class="text-xl font-bold text-slate-800">New Project</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <form id="projectForm" class="p-6 space-y-5">
                <input type="hidden" id="projectId">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Project Name *</label>
                    <input type="text" id="projectName" required class="form-input" placeholder="Enter project name">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Client Name *</label>
                    <input type="text" id="clientName" required class="form-input" placeholder="Enter client name">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Location *</label>
                    <input type="text" id="location" required class="form-input" placeholder="Enter location">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Budget (₹) *</label>
                    <input type="number" id="budget" required min="0" class="form-input" placeholder="0">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Start Date *</label>
                        <input type="date" id="startDate" required class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">End Date *</label>
                        <input type="date" id="endDate" required class="form-input">
                    </div>
                </div>
                <div id="dateError" class="text-red-500 text-sm hidden">End date must be after start date</div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                    <select id="status" class="form-input">
                        <option value="Planning">Planning</option>
                        <option value="In Progress">In Progress</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelBtn" class="flex-1 btn btn-secondary">Cancel</button>
                    <button type="submit" class="flex-1 btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-content w-full max-w-sm mx-4 p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Delete Project?</h3>
            <p class="text-slate-600 text-sm mb-6">All project data will be permanently removed. This action cannot be undone.</p>
            <div class="flex gap-3">
                <button id="cancelDelete" class="flex-1 btn btn-secondary">Cancel</button>
                <button id="confirmDelete" class="flex-1 btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, onAuthStateChanged } from './js/firebase-config.js';
        import { initAuthHeader } from './js/auth-header.js';
        import Storage from './js/firebase-storage.js';
        
        // Make Storage available globally
        window.Storage = Storage;
        
        // Utils
        const Utils = {
            formatNumber(num) { 
                if (num === null || num === undefined || isNaN(num)) return '0';
                return new Intl.NumberFormat('en-IN').format(num); 
            },
            formatDate(dateStr) { return new Date(dateStr).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }); },
            escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; },
            getDaysRemaining(endDate) {
                const end = new Date(endDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);
                return Math.ceil((end - today) / (1000 * 60 * 60 * 24));
            },
            getBudgetHealth(spent, budget) {
                spent = parseFloat(spent) || 0;
                budget = parseFloat(budget) || 0;
                if (budget <= 0) return { percent: 0, status: 'ok', color: 'green' };
                const percent = (spent / budget) * 100;
                if (isNaN(percent)) return { percent: 0, status: 'ok', color: 'green' };
                if (percent >= 100) return { percent, status: 'over', color: 'red' };
                if (percent >= 90) return { percent, status: 'critical', color: 'red' };
                if (percent >= 80) return { percent, status: 'warning', color: 'amber' };
                return { percent, status: 'ok', color: 'green' };
            },
            getDeadlineStatus(endDate, status) {
                if (status === 'Completed') return { class: 'text-green-500 bg-green-500/10', text: 'Completed', priority: 0 };
                const days = this.getDaysRemaining(endDate);
                if (days < 0) return { class: 'text-red-500 bg-red-500/20 animate-pulse', text: `${Math.abs(days)}d overdue`, priority: 4 };
                if (days === 0) return { class: 'text-red-500 bg-red-500/10', text: 'Due today', priority: 3 };
                if (days <= 3) return { class: 'text-red-400 bg-red-400/10', text: `${days}d left`, priority: 2 };
                if (days <= 7) return { class: 'text-amber-500 bg-amber-500/10', text: `${days}d left`, priority: 1 };
                return { class: 'text-gray-400', text: `${days}d left`, priority: 0 };
            },
            getPaymentStatus(dueDate, isPaid) {
                if (isPaid) return { class: 'text-green-500 bg-green-500/10', text: 'Paid' };
                const days = this.getDaysRemaining(dueDate);
                if (days < 0) return { class: 'text-red-500 bg-red-500/20 animate-pulse', text: `${Math.abs(days)}d overdue` };
                if (days === 0) return { class: 'text-red-500 bg-red-500/10', text: 'Due today' };
                if (days <= 3) return { class: 'text-amber-500 bg-amber-500/10', text: `Due in ${days}d` };
                return { class: 'text-gray-400', text: `Due in ${days}d` };
            }
        };
        window.Utils = Utils;
        
        // Wait for auth state before initializing
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // User is logged in
            initAuthHeader({ requireAuth: false });
            
            // Initialize the dashboard
            await initDashboard();
        });
        
        async function initDashboard() {
            showLoading(true);
            bindEvents();
            await generateAlerts();
            renderAlerts();
            await renderProjects();
            await updateMetrics();
            showLoading(false);
        }
        
        let currentFilter = 'all';
        let deleteTargetId = null;
        let alerts = [];
        
        function showLoading(show) {
            let loader = document.getElementById('loadingOverlay');
            if (show && !loader) {
                loader = document.createElement('div');
                loader.id = 'loadingOverlay';
                loader.className = 'fixed inset-0 bg-white/80 flex items-center justify-center z-50';
                loader.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin text-4xl text-sky-500 mb-4"></i><p class="text-slate-600">Loading...</p></div>';
                document.body.appendChild(loader);
            } else if (!show && loader) {
                loader.remove();
            }
        }
        
        async function generateAlerts() {
            alerts = [];
            const projects = await Storage.projects.getAll();
            const payments = await Storage.payments.getAll();

            for (const p of projects) {
                if (p.status === 'Completed') continue;
                const status = Utils.getDeadlineStatus(p.endDate, p.status);
                if (status.priority >= 2) {
                    alerts.push({ type: 'danger', icon: 'clock', text: `${p.name}: ${status.text}`, projectId: p.id });
                } else if (status.priority === 1) {
                    alerts.push({ type: 'warning', icon: 'clock', text: `${p.name}: ${status.text}`, projectId: p.id });
                }

                const spent = await getProjectSpent(p.id);
                const budget = await getEffectiveBudget(p);
                const health = Utils.getBudgetHealth(spent, budget);
                if (health.status === 'over') {
                    alerts.push({ type: 'danger', icon: 'exclamation-triangle', text: `${p.name}: Over budget by ₹${Utils.formatNumber(spent - budget)}`, projectId: p.id });
                } else if (health.status === 'critical') {
                    alerts.push({ type: 'danger', icon: 'chart-line', text: `${p.name}: 90%+ budget used`, projectId: p.id });
                } else if (health.status === 'warning') {
                    alerts.push({ type: 'warning', icon: 'chart-line', text: `${p.name}: 80%+ budget used`, projectId: p.id });
                }
            }

            payments.filter(p => !p.isPaid).forEach(p => {
                const status = Utils.getPaymentStatus(p.dueDate, p.isPaid);
                if (status.text.includes('overdue')) {
                    alerts.push({ type: 'danger', icon: 'wallet', text: `Payment overdue: ${p.vendorName} - ₹${Utils.formatNumber(p.amount)}` });
                } else if (status.text.includes('today') || status.text.includes('in 1d') || status.text.includes('in 2d') || status.text.includes('in 3d')) {
                    alerts.push({ type: 'warning', icon: 'wallet', text: `Payment ${status.text}: ${p.vendorName} - ₹${Utils.formatNumber(p.amount)}` });
                }
            });
        }

        async function getProjectSpent(projectId) {
            const materials = await Storage.materials.getByProject(projectId);
            const labour = await Storage.labour.getByProject(projectId);
            const expenses = await Storage.expenses.getByProject(projectId);
            
            const matTotal = materials.filter(m => m.status === 'used').reduce((s, m) => s + ((parseFloat(m.quantity) || 0) * (parseFloat(m.rate) || 0)), 0) 
                           - materials.filter(m => m.status === 'recovered').reduce((s, m) => s + ((parseFloat(m.quantity) || 0) * (parseFloat(m.rate) || 0)), 0);
            const labTotal = labour.reduce((s, l) => s + ((parseFloat(l.totalAmount) || 0) || ((parseFloat(l.dailyWage) || 0) * (parseFloat(l.daysWorked) || 0))), 0);
            const expTotal = expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            
            return Math.max(0, matTotal) + labTotal + expTotal;
        }

        async function getEffectiveBudget(project) {
            // With Fund Management system, we use the original project budget
            // Cross-project funding is handled through the virtual wallet system
            return parseFloat(project.budget) || 0;
        }

        function getDaysElapsed(startDate) {
            const start = new Date(startDate);
            const today = new Date();
            if (isNaN(start.getTime())) return 0;
            return Math.max(0, Math.ceil((today - start) / (1000 * 60 * 60 * 24)));
        }

        function renderAlerts() {
            const panel = document.getElementById('alertsPanel');
            const list = document.getElementById('alertsList');
            if (alerts.length === 0) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');
            list.innerHTML = alerts.map(a => `
                <div class="alert-item ${a.type}" ${a.projectId ? `onclick="window.location.href='project.html?id=${a.projectId}'" style="cursor:pointer"` : ''}>
                    <i class="fas fa-${a.icon} mr-2"></i>${a.text}
                </div>
            `).join('');
        }

        function bindEvents() {
            document.getElementById('addProjectBtn').addEventListener('click', () => openModal());
            document.getElementById('closeModal').addEventListener('click', () => closeModal());
            document.getElementById('cancelBtn').addEventListener('click', () => closeModal());
            document.getElementById('projectModal').addEventListener('click', e => { if (e.target.id === 'projectModal') closeModal(); });
            document.getElementById('projectForm').addEventListener('submit', e => handleSubmit(e));
            document.getElementById('statusFilter').addEventListener('change', e => { currentFilter = e.target.value; renderProjects(); });
            document.getElementById('cancelDelete').addEventListener('click', () => closeDeleteModal());
            document.getElementById('confirmDelete').addEventListener('click', () => confirmDelete());
            document.getElementById('deleteModal').addEventListener('click', e => { if (e.target.id === 'deleteModal') closeDeleteModal(); });
            document.getElementById('dismissAlerts')?.addEventListener('click', () => { document.getElementById('alertsPanel').classList.add('hidden'); });
        }

        async function openModal(projectId = null) {
            const modal = document.getElementById('projectModal');
            const form = document.getElementById('projectForm');
            form.reset();
            document.getElementById('projectId').value = '';
            document.getElementById('dateError').classList.add('hidden');

            if (projectId) {
                const p = await Storage.projects.getById(projectId);
                if (p) {
                    document.getElementById('modalTitle').textContent = 'Edit Project';
                    document.getElementById('projectId').value = p.id;
                    document.getElementById('projectName').value = p.name;
                    document.getElementById('clientName').value = p.clientName;
                    document.getElementById('location').value = p.location;
                    document.getElementById('budget').value = p.budget;
                    document.getElementById('startDate').value = p.startDate;
                    document.getElementById('endDate').value = p.endDate;
                    document.getElementById('status').value = p.status;
                }
            } else {
                document.getElementById('modalTitle').textContent = 'New Project';
                document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            }
            modal.classList.add('active');
            modal.classList.remove('hidden');
        }
        window.openModal = openModal;

        function closeModal() {
            const modal = document.getElementById('projectModal');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (new Date(end) < new Date(start)) { document.getElementById('dateError').classList.remove('hidden'); return; }

            const id = document.getElementById('projectId').value;
            const data = {
                name: document.getElementById('projectName').value.trim(),
                clientName: document.getElementById('clientName').value.trim(),
                location: document.getElementById('location').value.trim(),
                budget: parseFloat(document.getElementById('budget').value),
                startDate: start, endDate: end,
                status: document.getElementById('status').value
            };

            showLoading(true);
            if (id) await Storage.projects.update(id, data);
            else await Storage.projects.add(data);

            closeModal();
            await generateAlerts();
            renderAlerts();
            await renderProjects();
            await updateMetrics();
            showLoading(false);
            showToast(id ? 'Project updated' : 'Project created', 'success');
        }

        async function renderProjects() {
            const container = document.getElementById('projectsContainer');
            const empty = document.getElementById('emptyState');
            let projects = await Storage.projects.getAll();

            if (currentFilter !== 'all') projects = projects.filter(p => p.status === currentFilter);
            projects.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            if (!projects.length) { container.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            const cards = [];
            for (const p of projects) {
                cards.push(await createProjectCard(p));
            }
            container.innerHTML = cards.join('');
            
            container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openModal(btn.dataset.id); }));
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openDeleteModal(btn.dataset.id); }));
            container.querySelectorAll('.project-card').forEach(card => card.addEventListener('click', () => { window.location.href = `project.html?id=${card.dataset.id}`; }));
        }

        async function createProjectCard(p) {
            const spent = await getProjectSpent(p.id);
            const budget = await getEffectiveBudget(p);
            const health = Utils.getBudgetHealth(spent, budget);
            const deadline = Utils.getDeadlineStatus(p.endDate, p.status);
            const progress = p.status === 'Completed' ? 100 : p.status === 'Planning' ? 0 : Math.min(100, Math.round((getDaysElapsed(p.startDate) / Math.max(1, getDaysElapsed(p.startDate) + Utils.getDaysRemaining(p.endDate))) * 100));

            const statusClass = { 'Planning': 'status-planning', 'In Progress': 'status-in-progress', 'On Hold': 'status-on-hold', 'Completed': 'status-completed' }[p.status] || 'status-planning';

            return `
                <div class="project-card animate-fade-in" data-id="${p.id}">
                    <div class="flex items-start justify-between mb-4">
                        <span class="status-badge ${statusClass}">${p.status}</span>
                        <div class="flex gap-2">
                            <button type="button" class="action-btn edit-btn" data-id="${p.id}"><i class="fas fa-pen text-sm"></i></button>
                            <button type="button" class="action-btn delete delete-btn" data-id="${p.id}"><i class="fas fa-trash text-sm"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-2 text-lg">${Utils.escapeHtml(p.name)}</h3>
                    <div class="space-y-2 mb-4">
                        <p class="text-sm text-gray-600 flex items-center gap-2"><i class="fas fa-user w-4"></i>${Utils.escapeHtml(p.clientName)}</p>
                        <p class="text-sm text-gray-600 flex items-center gap-2"><i class="fas fa-map-marker-alt w-4"></i>${Utils.escapeHtml(p.location)}</p>
                    </div>
                    <div class="flex items-center justify-between mb-4 text-xs">
                        <span class="text-gray-500">${Utils.formatDate(p.startDate)}</span>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                        <span class="text-gray-500">${Utils.formatDate(p.endDate)}</span>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600 font-medium">Progress</span>
                            <span class="font-bold text-sky-600">${progress}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600 font-medium">Budget Health</span>
                            <span class="font-bold text-${health.color}-600">${Math.round(health.percent)}%</span>
                        </div>
                        <div class="health-meter"><div class="health-indicator" style="left:${Math.min(98, health.percent)}%"></div></div>
                    </div>
                    <div class="pt-4 border-t border-gray-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Budget</p>
                            <p class="text-xl font-bold text-sky-600">₹${Utils.formatNumber(budget)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500 mb-1">Spent</p>
                            <p class="text-sm font-semibold text-gray-700">₹${Utils.formatNumber(spent)}</p>
                        </div>
                    </div>
                    ${deadline.priority >= 2 ? `<div class="mt-3 px-3 py-2 rounded-lg ${deadline.class} text-xs font-semibold text-center">${deadline.text}</div>` : ''}
                </div>
            `;
        }

        async function updateMetrics() {
            const projects = await Storage.projects.getAll();
            const payments = await Storage.payments.getAll();

            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('activeProjects').textContent = projects.filter(p => p.status === 'In Progress').length;
            document.getElementById('completedProjects').textContent = projects.filter(p => p.status === 'Completed').length;
            document.getElementById('delayedProjects').textContent = projects.filter(p => p.status !== 'Completed' && Utils.getDaysRemaining(p.endDate) < 0).length;
            
            const pending = payments.filter(p => !p.isPaid).reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
            document.getElementById('pendingPayments').textContent = `₹${Utils.formatNumber(pending)}`;
        }

        function openDeleteModal(id) {
            deleteTargetId = id;
            const modal = document.getElementById('deleteModal');
            modal.classList.add('active');
            modal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
            deleteTargetId = null;
        }

        async function confirmDelete() {
            if (deleteTargetId) {
                showLoading(true);
                await Storage.projects.delete(deleteTargetId);
                await generateAlerts();
                renderAlerts();
                await renderProjects();
                await updateMetrics();
                showLoading(false);
                showToast('Project deleted', 'success');
            }
            closeDeleteModal();
        }

        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-check-circle mr-2 text-sky-500"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>
