<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maviya Constructions - Construction Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="css/styles-sidebar.css?v=8" rel="stylesheet">
</head>
<body>
    <!-- Playful Construction Loading Overlay -->
    <div id="pageLoader" class="loading-overlay">
        <div class="cartoon-icon icon-dashboard loading" style="width: 80px; height: 80px; border-radius: 24px; margin-bottom: 1rem;">
            <div class="icon-projects-board" style="width: 36px; height: 44px;"></div>
        </div>
        <div class="loader-blocks">
            <div class="loader-block"></div>
            <div class="loader-block"></div>
            <div class="loader-block"></div>
            <div class="loader-block"></div>
        </div>
        <p class="loading-text">Building your dashboard<span class="loading-text-dots"></span></p>
    </div>

    <!-- App Container with Sidebar -->
    <div class="app-container">
        <!-- Floating Sidebar -->
        <aside class="sidebar">
            <!-- Logo Section -->
            <div class="sidebar-logo">
                <div class="logo-icon">
                    <i class="fas fa-hard-hat"></i>
                </div>
                <div class="logo-text">Maviya</div>
                <div class="logo-subtitle">Construction Management</div>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                <a href="compare.html" class="sidebar-btn compare">
                    <div class="sidebar-btn-icon">
                        <div class="cartoon-icon icon-compare">
                            <div class="icon-compare-bars">
                                <div class="icon-compare-bar"></div>
                                <div class="icon-compare-bar"></div>
                                <div class="icon-compare-bar"></div>
                                <div class="icon-compare-bar"></div>
                            </div>
                        </div>
                    </div>
                    <span class="sidebar-btn-text">Compare</span>
                </a>
                <a href="payments.html" class="sidebar-btn payment">
                    <div class="sidebar-btn-icon">
                        <div class="cartoon-icon icon-payment">
                            <div class="icon-payment-card"></div>
                        </div>
                    </div>
                    <span class="sidebar-btn-text">Payment</span>
                </a>
                <a href="materials.html" class="sidebar-btn stock">
                    <div class="sidebar-btn-icon">
                        <div class="cartoon-icon icon-stock">
                            <div class="icon-stock-box"></div>
                        </div>
                    </div>
                    <span class="sidebar-btn-text">Stock</span>
                </a>
                <a href="funds.html" class="sidebar-btn funds">
                    <div class="sidebar-btn-icon">
                        <div class="cartoon-icon icon-funds">
                            <div class="icon-funds-wallet"></div>
                        </div>
                    </div>
                    <span class="sidebar-btn-text">Funds</span>
                </a>
            </nav>

            <!-- User Menu -->
            <div class="relative">
                <button id="userMenuBtn" class="sidebar-logout">
                    <div class="cartoon-icon icon-user icon-sm">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="icon-user-avatar"></div>
                            <div class="icon-user-body"></div>
                        </div>
                    </div>
                    <span id="userEmailDisplay" class="text-xs max-w-[120px] truncate"></span>
                </button>
                <div id="userMenu" class="hidden absolute bottom-full left-0 right-0 mb-2 bg-white rounded-lg shadow-xl border border-slate-200 py-2 z-50">
                    <div class="px-4 py-2 border-b border-slate-200">
                        <p class="text-xs text-slate-500">Signed in as</p>
                        <p id="userEmailFull" class="text-sm font-semibold text-slate-800 truncate"></p>
                    </div>
                    <a href="migrate.html" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition">
                        <i class="fas fa-database text-sky-500"></i>
                        Data Migration
                    </a>
                    <button id="logoutBtn" class="w-full flex items-center gap-3 px-4 py-2 text-sm text-rose-600 hover:bg-rose-50 transition">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header with Avatar -->
            <div class="content-header">
                <h1 class="greeting">Dashboard</h1>
                <div class="user-avatar">
                    ðŸ‘¤
                </div>
            </div>

            <!-- Alerts Panel -->
            <section id="alertsPanel" class="mb-8 hidden animate-slide-in">
                <div class="card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="fas fa-bell text-sky-500"></i>
                            Alerts & Reminders
                        </h2>
                        <button id="dismissAlerts" class="text-sm text-gray-500 hover:text-gray-700 transition">Dismiss All</button>
                    </div>
                    <div id="alertsList" class="max-h-64 overflow-y-auto space-y-2"></div>
                </div>
            </section>

            <!-- Metrics Grid -->
            <section class="metrics-grid mb-8">
                <div class="metric-card total animate-fade-in" style="animation-delay: 0.1s">
                    <div class="metric-icon">
                        <div class="cartoon-icon icon-projects">
                            <div class="icon-projects-board"></div>
                        </div>
                    </div>
                    <p class="metric-label">Total Projects</p>
                    <p class="metric-value" id="totalProjects">0</p>
                </div>
                <div class="metric-card active animate-fade-in" style="animation-delay: 0.2s">
                    <div class="metric-icon">
                        <div class="cartoon-icon icon-active">
                            <div class="icon-active-gear"></div>
                        </div>
                    </div>
                    <p class="metric-label">Active</p>
                    <p class="metric-value" id="activeProjects">0</p>
                </div>
                <div class="metric-card completed animate-fade-in" style="animation-delay: 0.3s">
                    <div class="metric-icon">
                        <div class="cartoon-icon icon-completed">
                            <div class="icon-completed-check"></div>
                        </div>
                    </div>
                    <p class="metric-label">Completed</p>
                    <p class="metric-value" id="completedProjects">0</p>
                </div>
                <div class="metric-card delayed animate-fade-in" style="animation-delay: 0.4s">
                    <div class="metric-icon">
                        <div class="cartoon-icon icon-delayed">
                            <div class="icon-delayed-clock"></div>
                        </div>
                    </div>
                    <p class="metric-label">Delayed</p>
                    <p class="metric-value" id="delayedProjects">0</p>
                </div>
                <div class="metric-card payments animate-fade-in" style="animation-delay: 0.5s">
                    <div class="metric-icon">
                        <div class="cartoon-icon icon-pending">
                            <div class="icon-pending-coins">
                                <div class="icon-pending-coin"></div>
                                <div class="icon-pending-coin"></div>
                            </div>
                        </div>
                    </div>
                    <p class="metric-label">Pending Payments</p>
                    <p class="metric-value" id="pendingPayments">â‚¹0</p>
                </div>
            </section>

            <!-- Projects Section -->
            <section class="projects-section animate-scale-in">
                <div class="projects-header">
                    <h2 class="projects-title">
                        <i class="fas fa-list-check"></i>
                        Projects
                    </h2>
                    <div class="projects-controls">
                        <select id="statusFilter" class="filter-dropdown">
                            <option value="all">All Status</option>
                            <option value="Planning">Planning</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <button id="addProjectBtn" class="btn-add-project">
                            <i class="fas fa-plus"></i>
                            New Project
                        </button>
                    </div>
                </div>
                
                <div id="projectsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                
                <div id="emptyState" class="empty-state hidden">
                    <i class="fas fa-folder-open"></i>
                    <p class="text-lg font-medium">No projects yet</p>
                    <p class="text-sm mt-2">Create your first project to get started!</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Project Modal -->
    <div id="projectModal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-content w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="modalTitle" class="text-xl font-bold text-slate-800">New Project</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <form id="projectForm" class="p-6">
                <input type="hidden" id="projectId">
                <div class="grid grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Project Name *</label>
                        <input type="text" id="projectName" required class="form-input" placeholder="Enter project name">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Client Name *</label>
                        <input type="text" id="clientName" required class="form-input" placeholder="Enter client name">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Location *</label>
                        <input type="text" id="location" required class="form-input" placeholder="Enter location">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Budget (â‚¹) *</label>
                        <input type="number" id="budget" required min="0" class="form-input" placeholder="0">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-5 mb-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Start Date *</label>
                        <input type="date" id="startDate" required class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">End Date *</label>
                        <input type="date" id="endDate" required class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                        <select id="status" class="form-input">
                            <option value="Planning">Planning</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div id="dateError" class="text-red-500 text-sm hidden mb-4">End date must be after start date</div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelBtn" class="flex-1 btn btn-secondary">Cancel</button>
                    <button type="submit" class="flex-1 btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-content modal-sm w-full mx-4 p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Delete Project?</h3>
            <p class="text-slate-600 text-sm mb-6">All project data will be permanently removed. This action cannot be undone.</p>
            <div class="flex gap-3">
                <button id="cancelDelete" class="flex-1 btn btn-secondary">Cancel</button>
                <button id="confirmDelete" class="flex-1 btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, onAuthStateChanged } from './js/firebase-config.js';
        import { initAuthHeader } from './js/auth-header.js';
        import Storage from './js/firebase-storage.js';
        
        // Hide loader function
        function hideLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) {
                loader.classList.add('hidden');
            }
        }
        
        // Make Storage available globally
        window.Storage = Storage;
        
        // Utils
        const Utils = {
            formatNumber(num) { 
                if (num === null || num === undefined || isNaN(num)) return '0';
                return new Intl.NumberFormat('en-IN').format(num); 
            },
            formatDate(dateStr) { return new Date(dateStr).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }); },
            escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; },
            getDaysRemaining(endDate) {
                const end = new Date(endDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);
                return Math.ceil((end - today) / (1000 * 60 * 60 * 24));
            },
            getBudgetHealth(spent, budget) {
                spent = parseFloat(spent) || 0;
                budget = parseFloat(budget) || 0;
                if (budget <= 0) return { percent: 0, status: 'ok', color: 'green' };
                const percent = (spent / budget) * 100;
                if (isNaN(percent)) return { percent: 0, status: 'ok', color: 'green' };
                if (percent >= 100) return { percent, status: 'over', color: 'red' };
                if (percent >= 90) return { percent, status: 'critical', color: 'red' };
                if (percent >= 80) return { percent, status: 'warning', color: 'amber' };
                return { percent, status: 'ok', color: 'green' };
            },
            getDeadlineStatus(endDate, status) {
                if (status === 'Completed') return { class: 'text-green-500 bg-green-500/10', text: 'Completed', priority: 0 };
                const days = this.getDaysRemaining(endDate);
                if (days < 0) return { class: 'text-red-500 bg-red-500/20 animate-pulse', text: `${Math.abs(days)}d overdue`, priority: 4 };
                if (days === 0) return { class: 'text-red-500 bg-red-500/10', text: 'Due today', priority: 3 };
                if (days <= 3) return { class: 'text-red-400 bg-red-400/10', text: `${days}d left`, priority: 2 };
                if (days <= 7) return { class: 'text-amber-500 bg-amber-500/10', text: `${days}d left`, priority: 1 };
                return { class: 'text-gray-400', text: `${days}d left`, priority: 0 };
            },
            getPaymentStatus(dueDate, isPaid) {
                if (isPaid) return { class: 'text-green-500 bg-green-500/10', text: 'Paid' };
                const days = this.getDaysRemaining(dueDate);
                if (days < 0) return { class: 'text-red-500 bg-red-500/20 animate-pulse', text: `${Math.abs(days)}d overdue` };
                if (days === 0) return { class: 'text-red-500 bg-red-500/10', text: 'Due today' };
                if (days <= 3) return { class: 'text-amber-500 bg-amber-500/10', text: `Due in ${days}d` };
                return { class: 'text-gray-400', text: `Due in ${days}d` };
            }
        };
        window.Utils = Utils;
        
        // Wait for auth state before initializing
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // User is logged in
            initAuthHeader({ requireAuth: false });
            
            // Initialize the dashboard
            await initDashboard();
        });
        
        async function initDashboard() {
            showLoading(true);
            bindEvents();
            await generateAlerts();
            renderAlerts();
            await renderProjects();
            await updateMetrics();
            showLoading(false);
            hideLoader(); // Hide the page loader
        }
        
        let currentFilter = 'all';
        let deleteTargetId = null;
        let alerts = [];
        
        function showLoading(show) {
            let loader = document.getElementById('loadingOverlay');
            if (show && !loader) {
                loader = document.createElement('div');
                loader.id = 'loadingOverlay';
                loader.className = 'fixed inset-0 bg-white/80 flex items-center justify-center z-50';
                loader.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin text-4xl text-sky-500 mb-4"></i><p class="text-slate-600">Loading...</p></div>';
                document.body.appendChild(loader);
            } else if (!show && loader) {
                loader.remove();
            }
        }
        
        async function generateAlerts() {
            alerts = [];
            const projects = await Storage.projects.getAll();
            const payments = await Storage.payments.getAll();

            for (const p of projects) {
                if (p.status === 'Completed') continue;
                const status = Utils.getDeadlineStatus(p.endDate, p.status);
                if (status.priority >= 2) {
                    alerts.push({ type: 'danger', icon: 'clock', text: `${p.name}: ${status.text}`, projectId: p.id });
                } else if (status.priority === 1) {
                    alerts.push({ type: 'warning', icon: 'clock', text: `${p.name}: ${status.text}`, projectId: p.id });
                }

                const spent = await getProjectSpent(p.id);
                const budget = await getEffectiveBudget(p);
                const health = Utils.getBudgetHealth(spent, budget);
                if (health.status === 'over') {
                    alerts.push({ type: 'danger', icon: 'exclamation-triangle', text: `${p.name}: Over budget by â‚¹${Utils.formatNumber(spent - budget)}`, projectId: p.id });
                } else if (health.status === 'critical') {
                    alerts.push({ type: 'danger', icon: 'chart-line', text: `${p.name}: 90%+ budget used`, projectId: p.id });
                } else if (health.status === 'warning') {
                    alerts.push({ type: 'warning', icon: 'chart-line', text: `${p.name}: 80%+ budget used`, projectId: p.id });
                }
            }

            payments.filter(p => !p.isPaid).forEach(p => {
                const status = Utils.getPaymentStatus(p.dueDate, p.isPaid);
                if (status.text.includes('overdue')) {
                    alerts.push({ type: 'danger', icon: 'wallet', text: `Payment overdue: ${p.vendorName} - â‚¹${Utils.formatNumber(p.amount)}` });
                } else if (status.text.includes('today') || status.text.includes('in 1d') || status.text.includes('in 2d') || status.text.includes('in 3d')) {
                    alerts.push({ type: 'warning', icon: 'wallet', text: `Payment ${status.text}: ${p.vendorName} - â‚¹${Utils.formatNumber(p.amount)}` });
                }
            });
        }

        async function getProjectSpent(projectId) {
            const materials = await Storage.materials.getByProject(projectId);
            const labour = await Storage.labour.getByProject(projectId);
            const expenses = await Storage.expenses.getByProject(projectId);
            
            const matTotal = materials.filter(m => m.status === 'used').reduce((s, m) => s + ((parseFloat(m.quantity) || 0) * (parseFloat(m.rate) || 0)), 0) 
                           - materials.filter(m => m.status === 'recovered').reduce((s, m) => s + ((parseFloat(m.quantity) || 0) * (parseFloat(m.rate) || 0)), 0);
            const labTotal = labour.reduce((s, l) => s + ((parseFloat(l.totalAmount) || 0) || ((parseFloat(l.dailyWage) || 0) * (parseFloat(l.daysWorked) || 0))), 0);
            const expTotal = expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            
            return Math.max(0, matTotal) + labTotal + expTotal;
        }

        async function getEffectiveBudget(project) {
            // With Fund Management system, we use the original project budget
            // Cross-project funding is handled through the virtual wallet system
            return parseFloat(project.budget) || 0;
        }

        function getDaysElapsed(startDate) {
            const start = new Date(startDate);
            const today = new Date();
            if (isNaN(start.getTime())) return 0;
            return Math.max(0, Math.ceil((today - start) / (1000 * 60 * 60 * 24)));
        }

        function renderAlerts() {
            const panel = document.getElementById('alertsPanel');
            const list = document.getElementById('alertsList');
            if (alerts.length === 0) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');
            list.innerHTML = alerts.map(a => `
                <div class="alert-item ${a.type}" ${a.projectId ? `onclick="window.location.href='project.html?id=${a.projectId}'" style="cursor:pointer"` : ''}>
                    <i class="fas fa-${a.icon} mr-2"></i>${a.text}
                </div>
            `).join('');
        }

        function bindEvents() {
            document.getElementById('addProjectBtn').addEventListener('click', () => openModal());
            document.getElementById('closeModal').addEventListener('click', () => closeModal());
            document.getElementById('cancelBtn').addEventListener('click', () => closeModal());
            document.getElementById('projectModal').addEventListener('click', e => { if (e.target.id === 'projectModal') closeModal(); });
            document.getElementById('projectForm').addEventListener('submit', e => handleSubmit(e));
            document.getElementById('statusFilter').addEventListener('change', e => { currentFilter = e.target.value; renderProjects(); });
            document.getElementById('cancelDelete').addEventListener('click', () => closeDeleteModal());
            document.getElementById('confirmDelete').addEventListener('click', () => confirmDelete());
            document.getElementById('deleteModal').addEventListener('click', e => { if (e.target.id === 'deleteModal') closeDeleteModal(); });
            document.getElementById('dismissAlerts')?.addEventListener('click', () => { document.getElementById('alertsPanel').classList.add('hidden'); });
        }

        async function openModal(projectId = null) {
            const modal = document.getElementById('projectModal');
            const form = document.getElementById('projectForm');
            form.reset();
            document.getElementById('projectId').value = '';
            document.getElementById('dateError').classList.add('hidden');

            if (projectId) {
                const p = await Storage.projects.getById(projectId);
                if (p) {
                    document.getElementById('modalTitle').textContent = 'Edit Project';
                    document.getElementById('projectId').value = p.id;
                    document.getElementById('projectName').value = p.name;
                    document.getElementById('clientName').value = p.clientName;
                    document.getElementById('location').value = p.location;
                    document.getElementById('budget').value = p.budget;
                    document.getElementById('startDate').value = p.startDate;
                    document.getElementById('endDate').value = p.endDate;
                    document.getElementById('status').value = p.status;
                }
            } else {
                document.getElementById('modalTitle').textContent = 'New Project';
                document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            }
            modal.classList.add('active');
            modal.classList.remove('hidden');
        }
        window.openModal = openModal;

        function closeModal() {
            const modal = document.getElementById('projectModal');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (new Date(end) < new Date(start)) { document.getElementById('dateError').classList.remove('hidden'); return; }

            const id = document.getElementById('projectId').value;
            const data = {
                name: document.getElementById('projectName').value.trim(),
                clientName: document.getElementById('clientName').value.trim(),
                location: document.getElementById('location').value.trim(),
                budget: parseFloat(document.getElementById('budget').value),
                startDate: start, endDate: end,
                status: document.getElementById('status').value
            };

            showLoading(true);
            if (id) await Storage.projects.update(id, data);
            else await Storage.projects.add(data);

            closeModal();
            await generateAlerts();
            renderAlerts();
            await renderProjects();
            await updateMetrics();
            showLoading(false);
            showToast(id ? 'Project updated' : 'Project created', 'success');
        }

        async function renderProjects() {
            const container = document.getElementById('projectsContainer');
            const empty = document.getElementById('emptyState');
            let projects = await Storage.projects.getAll();

            if (currentFilter !== 'all') projects = projects.filter(p => p.status === currentFilter);
            projects.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            if (!projects.length) { container.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            const cards = [];
            for (const p of projects) {
                cards.push(await createProjectCard(p));
            }
            container.innerHTML = cards.join('');
            
            container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openModal(btn.dataset.id); }));
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openDeleteModal(btn.dataset.id); }));
            container.querySelectorAll('.project-card').forEach(card => card.addEventListener('click', () => { window.location.href = `project.html?id=${card.dataset.id}`; }));
        }

        async function createProjectCard(p) {
            const spent = await getProjectSpent(p.id);
            const budget = await getEffectiveBudget(p);
            const health = Utils.getBudgetHealth(spent, budget);
            const deadline = Utils.getDeadlineStatus(p.endDate, p.status);
            const progress = p.status === 'Completed' ? 100 : p.status === 'Planning' ? 0 : Math.min(100, Math.round((getDaysElapsed(p.startDate) / Math.max(1, getDaysElapsed(p.startDate) + Utils.getDaysRemaining(p.endDate))) * 100));

            const statusDot = p.status === 'In Progress' ? 'active' : p.status === 'Completed' ? 'completed' : Utils.getDaysRemaining(p.endDate) < 0 ? 'delayed' : 'active';
            const progressClass = p.status === 'In Progress' ? 'active' : p.status === 'Completed' ? 'completed' : 'delayed';
            const statusPillClass = p.status === 'In Progress' ? 'active' : p.status === 'Completed' ? 'completed' : 'delayed';

            return `
                <div class="project-card animate-fade-in" data-id="${p.id}">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="project-status-dot ${statusDot}"></div>
                        <div class="flex-1 project-info">
                            <h3 class="project-name">${Utils.escapeHtml(p.name)}</h3>
                            <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">${Utils.escapeHtml(p.clientName)} â€¢ ${Utils.escapeHtml(p.location)}</p>
                        </div>
                        <span class="status-pill ${statusPillClass}">${p.status}</span>
                    </div>
                    <div class="mb-3">
                        <div class="progress-bar">
                            <div class="progress-fill ${progressClass}" style="width:${progress}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
                            <span style="color: var(--text-light);">${progress}% Complete</span>
                            <span style="color: var(--text-light);">${Utils.formatDate(p.endDate)}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid #F0F4F8;">
                        <div>
                            <p style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Budget</p>
                            <p style="font-size: 1.125rem; font-weight: 700; color: var(--blueprint-blue);">â‚¹${Utils.formatNumber(budget)}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Spent</p>
                            <p style="font-size: 0.875rem; font-weight: 600; color: var(--text);">â‚¹${Utils.formatNumber(spent)}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="action-btn edit-btn" data-id="${p.id}" style="width: 36px; height: 36px; border-radius: 12px; border: 2px solid #E8F4F8; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"><i class="fas fa-pen" style="font-size: 0.75rem;"></i></button>
                            <button type="button" class="action-btn delete delete-btn" data-id="${p.id}" style="width: 36px; height: 36px; border-radius: 12px; border: 2px solid #FFE8DC; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--brick-orange);"><i class="fas fa-trash" style="font-size: 0.75rem;"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function updateMetrics() {
            const projects = await Storage.projects.getAll();
            const payments = await Storage.payments.getAll();

            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('activeProjects').textContent = projects.filter(p => p.status === 'In Progress').length;
            document.getElementById('completedProjects').textContent = projects.filter(p => p.status === 'Completed').length;
            document.getElementById('delayedProjects').textContent = projects.filter(p => p.status !== 'Completed' && Utils.getDaysRemaining(p.endDate) < 0).length;
            
            const pending = payments.filter(p => !p.isPaid).reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
            document.getElementById('pendingPayments').textContent = `â‚¹${Utils.formatNumber(pending)}`;
        }

        function openDeleteModal(id) {
            deleteTargetId = id;
            const modal = document.getElementById('deleteModal');
            modal.classList.add('active');
            modal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
            deleteTargetId = null;
        }

        async function confirmDelete() {
            if (deleteTargetId) {
                showLoading(true);
                await Storage.projects.delete(deleteTargetId);
                await generateAlerts();
                renderAlerts();
                await renderProjects();
                await updateMetrics();
                showLoading(false);
                showToast('Project deleted', 'success');
            }
            closeDeleteModal();
        }

        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-check-circle mr-2 text-sky-500"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }
    </script>

    <!-- Scroll Animation Script -->
    <script>
        // Smooth scroll animations on element visibility
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        // Observe all cards and metrics when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for elements to be rendered
            setTimeout(() => {
                const elements = document.querySelectorAll('.metric-card, .project-card');
                elements.forEach((el, index) => {
                    if (el) {
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(20px)';
                        el.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
                        observer.observe(el);
                    }
                });
            }, 100);

            // Sidebar scroll effect
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.addEventListener('scroll', () => {
                    if (sidebar && mainContent.scrollTop > 20) {
                        sidebar.style.boxShadow = '0 15px 40px -10px rgba(91, 155, 213, 0.25)';
                    } else if (sidebar) {
                        sidebar.style.boxShadow = '0 10px 30px -5px rgba(91, 155, 213, 0.15)';
                    }
                });
            }
        });
    </script>
</body>
</html>