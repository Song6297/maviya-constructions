<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Management - Maviya Constructions</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="css/styles.css" rel="stylesheet">
</head>
<body class="min-h-screen">
    <header class="header-main sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="w-10 h-10 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-xl flex items-center justify-center transition-all hover:scale-110">
                    <i class="fas fa-arrow-left text-white"></i>
                </a>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-wallet text-sky-500 text-lg"></i>
                    </div>
                    <h1 class="text-lg font-bold text-white">Fund Management</h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="generateCompleteFundReportBtn" class="btn-header bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 shadow-lg hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-file-pdf"></i>
                    <span class="hidden sm:inline">Complete Report</span>
                </button>
                <button id="generateFundUnderstandingBtn" class="btn-header bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 shadow-lg hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-book"></i>
                    <span class="hidden sm:inline">Understanding Guide</span>
                </button>
                <button id="reconcileBtn" class="btn-header bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 shadow-lg hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-balance-scale"></i>
                    <span class="hidden sm:inline">Reconcile</span>
                </button>
                <button id="addPaymentBtn" class="btn-header bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 shadow-lg hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-plus"></i>
                    <span class="hidden sm:inline">Add Payment</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Overall Fund Status -->
        <section class="mb-6">
            <div class="card p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-green-500 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    Overall Fund Status
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="overallStatus">
                    <!-- Dynamic content -->
                </div>
            </div>
        </section>

        <!-- Tabs -->
        <nav class="card rounded-t-2xl border-b-0 flex overflow-x-auto">
            <button class="tab-btn active" data-tab="wallets"><i class="fas fa-wallet mr-2"></i>Project Wallets</button>
            <button class="tab-btn" data-tab="payments"><i class="fas fa-money-bill-wave mr-2"></i>Payment Allocation</button>
            <button class="tab-btn" data-tab="loans"><i class="fas fa-handshake mr-2"></i>Inter-Project Loans</button>
            <button class="tab-btn" data-tab="unallocated"><i class="fas fa-question-circle mr-2"></i>Unallocated Funds</button>
        </nav>

        <div class="card rounded-t-none border-t-0">
            <!-- Project Wallets Tab -->
            <div id="walletsTab" class="tab-content p-5">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-wallet text-white text-lg"></i>
                        </div>
                        Virtual Project Wallets
                    </h2>
                    <button id="refreshWalletsBtn" class="btn-secondary bg-gradient-to-r from-slate-500 to-gray-600 hover:from-slate-600 hover:to-gray-700 shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                <div id="projectWalletsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Payment Allocation Tab -->
            <div id="paymentsTab" class="tab-content p-5 hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-green-500 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-money-bill-wave text-white text-lg"></i>
                        </div>
                        Payment Allocation History
                    </h2>
                    <button id="allocatePaymentBtn" class="btn-add bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl">
                        <i class="fas fa-plus"></i>
                        <span>Allocate Payment</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>Total Amount</th>
                                <th>Projects</th>
                                <th>Method & Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentAllocationsTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
                <div id="paymentsEmpty" class="empty-state hidden">
                    <i class="fas fa-money-bill-wave"></i>
                    <p>No payment allocations yet</p>
                </div>
            </div>

            <!-- Inter-Project Loans Tab -->
            <div id="loansTab" class="tab-content p-5 hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-handshake text-white text-lg"></i>
                        </div>
                        Inter-Project Loans
                    </h2>
                    <button id="recordExpenseBtn" class="btn-add bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl">
                        <i class="fas fa-plus"></i>
                        <span>Record Cross-Project Expense</span>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold text-slate-800 mb-3">Active Loans</h3>
                        <div id="activeLoansContainer" class="space-y-3">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-800 mb-3">Recent Settlements</h3>
                        <div id="recentSettlementsContainer" class="space-y-3">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unallocated Funds Tab -->
            <div id="unallocatedTab" class="tab-content p-5 hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-red-400 to-rose-500 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-question-circle text-white text-lg"></i>
                        </div>
                        Unallocated Funds
                    </h2>
                </div>
                <div id="unallocatedFundsContainer">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </main>

    <!-- Payment Allocation Modal -->
    <div id="paymentAllocationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-slate-800">Allocate Client Payment</h3>
                <button class="close-modal text-slate-400 hover:text-sky-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="paymentAllocationForm" class="p-5 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Total Amount (₹) *</label>
                        <input type="number" id="totalPaymentAmount" required min="1" step="0.01" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Payment Date *</label>
                        <input type="date" id="paymentDate" required class="form-input">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">From (Client) *</label>
                        <input type="text" id="paymentFrom" required class="form-input" placeholder="Client name">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Received By *</label>
                        <input type="text" id="paymentReceivedBy" required class="form-input" placeholder="Person who received">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Payment Method</label>
                    <select id="paymentMethod" class="form-input">
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Cash">Cash</option>
                        <option value="Cheque">Cheque</option>
                        <option value="UPI">UPI</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Project Allocations</label>
                    <div id="allocationsList" class="space-y-3">
                        <!-- Dynamic allocation rows -->
                    </div>
                    <button type="button" id="addAllocationBtn" class="btn-secondary text-sm mt-2">
                        <i class="fas fa-plus mr-1"></i>Add Project
                    </button>
                </div>

                <div class="bg-slate-50 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Total Allocated:</span>
                        <span id="totalAllocated" class="font-bold text-slate-800">₹0</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-sm text-slate-600">Remaining:</span>
                        <span id="remainingAmount" class="font-bold text-rose-600">₹0</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Notes</label>
                    <textarea id="paymentNotes" rows="2" class="form-input" placeholder="Optional notes"></textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" class="cancel-modal flex-1 btn-secondary">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary">Allocate Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cross-Project Expense Modal -->
    <div id="crossProjectExpenseModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-slate-800">Record Cross-Project Expense</h3>
                <button class="close-modal text-slate-400 hover:text-sky-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="crossProjectExpenseForm" class="p-5 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Beneficiary Project *</label>
                    <select id="beneficiaryProject" required class="form-input">
                        <option value="">Select project that benefits from this expense</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Expense Type *</label>
                        <select id="expenseType" required class="form-input">
                            <option value="material">Material</option>
                            <option value="labour">Labour</option>
                            <option value="expense">Other Expense</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Total Amount (₹) *</label>
                        <input type="number" id="expenseAmount" required min="1" step="0.01" class="form-input">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Description *</label>
                    <input type="text" id="expenseDescription" required class="form-input" placeholder="What was purchased/paid for">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Date *</label>
                    <input type="date" id="expenseDate" required class="form-input">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Payment Sources</label>
                    <div id="paymentSourcesList" class="space-y-3">
                        <!-- Dynamic payment source rows -->
                    </div>
                    <button type="button" id="addPaymentSourceBtn" class="btn-secondary text-sm mt-2">
                        <i class="fas fa-plus mr-1"></i>Add Payment Source
                    </button>
                </div>

                <div class="bg-slate-50 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Total Paid:</span>
                        <span id="totalPaid" class="font-bold text-slate-800">₹0</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-sm text-slate-600">Remaining:</span>
                        <span id="remainingExpense" class="font-bold text-rose-600">₹0</span>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" class="cancel-modal flex-1 btn-secondary">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary">Record Expense</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, onAuthStateChanged } from './js/firebase-config.js';
        import Storage from './js/firebase-storage.js';
        import FundManagement from './js/fund-management.js?v=2';
        
        window.Storage = Storage;
        window.FundManagement = FundManagement;
        
        // Wait for auth state before initializing
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Initialize fund management app
            try {
                await FundsApp.init();
            } catch (error) {
                console.error('Error initializing funds app:', error);
            }
        });

        // Fund Management App
        const FundsApp = {
            projects: [],
            allocationCount: 0,
            paymentSourceCount: 0,

            async init() {
                this.projects = await Storage.projects.getAll();
                this.bindEvents();
                await this.renderAll();
            },

            bindEvents() {
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => 
                    btn.addEventListener('click', () => this.switchTab(btn.dataset.tab))
                );

                // Modal controls
                document.querySelectorAll('.close-modal, .cancel-modal').forEach(btn => 
                    btn.addEventListener('click', () => this.closeAllModals())
                );

                // Main buttons
                document.getElementById('addPaymentBtn').addEventListener('click', () => this.openPaymentAllocationModal());
                document.getElementById('allocatePaymentBtn').addEventListener('click', () => this.openPaymentAllocationModal());
                document.getElementById('recordExpenseBtn').addEventListener('click', () => this.openCrossProjectExpenseModal());
                document.getElementById('refreshWalletsBtn').addEventListener('click', () => this.renderProjectWallets());
                document.getElementById('generateCompleteFundReportBtn').addEventListener('click', () => this.generateCompleteFundReport());
                document.getElementById('generateFundUnderstandingBtn').addEventListener('click', () => this.generateFundUnderstandingGuide());
                document.getElementById('reconcileBtn').addEventListener('click', () => this.reconcileSystem());

                // Form submissions
                document.getElementById('paymentAllocationForm').addEventListener('submit', (e) => this.handlePaymentAllocation(e));
                document.getElementById('crossProjectExpenseForm').addEventListener('submit', (e) => this.handleCrossProjectExpense(e));

                // Dynamic form controls
                document.getElementById('addAllocationBtn').addEventListener('click', () => this.addAllocationRow());
                document.getElementById('addPaymentSourceBtn').addEventListener('click', () => this.addPaymentSourceRow());
                document.getElementById('totalPaymentAmount').addEventListener('input', () => this.updateAllocationCalculations());
                document.getElementById('expenseAmount').addEventListener('input', () => this.updatePaymentSourceCalculations());
            },

            async switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}Tab`).classList.remove('hidden');
                
                if (tabName === 'wallets') await this.renderProjectWallets();
                if (tabName === 'payments') await this.renderPaymentAllocations();
                if (tabName === 'loans') await this.renderInterProjectLoans();
                if (tabName === 'unallocated') await this.renderUnallocatedFunds();
            },

            async renderAll() {
                await this.renderOverallStatus();
                await this.renderProjectWallets();
            },

            async renderOverallStatus() {
                const status = await FundManagement.getOverallFundStatus();
                const container = document.getElementById('overallStatus');
                
                container.innerHTML = `
                    <div class="metric-card">
                        <p class="text-slate-600 text-sm">Total Virtual Balance</p>
                        <p class="font-bold text-2xl text-sky-600">₹${this.formatNumber(status.totalVirtualBalance)}</p>
                    </div>
                    <div class="metric-card">
                        <p class="text-slate-600 text-sm">Active Inter-Project Loans</p>
                        <p class="font-bold text-2xl text-amber-600">₹${this.formatNumber(status.totalActiveLoans)}</p>
                    </div>
                    <div class="metric-card">
                        <p class="text-slate-600 text-sm">Projects</p>
                        <p class="font-bold text-2xl text-slate-800">${status.projectSummaries.length}</p>
                    </div>
                    <div class="metric-card ${status.isBalanced ? 'border-emerald-200 bg-emerald-50' : 'border-rose-200 bg-rose-50'}">
                        <p class="text-slate-600 text-sm">System Status</p>
                        <p class="font-bold text-lg ${status.isBalanced ? 'text-emerald-600' : 'text-rose-600'}">
                            ${status.isBalanced ? '✓ Balanced' : '⚠ Unbalanced'}
                        </p>
                    </div>
                `;
            },

            async renderProjectWallets() {
                const status = await FundManagement.getOverallFundStatus();
                const container = document.getElementById('projectWalletsGrid');
                
                if (!status.projectSummaries.length) {
                    container.innerHTML = '<div class="col-span-full text-center text-slate-500 py-8">No projects found</div>';
                    return;
                }

                container.innerHTML = status.projectSummaries.map(project => `
                    <div class="card p-4 hover:shadow-lg transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="font-bold text-slate-800">${project.projectName}</h3>
                                <p class="text-xs text-slate-500">ID: ${project.projectId}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-600">Net Available</p>
                                <p class="font-bold text-lg ${project.netAvailableBalance >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
                                    ₹${this.formatNumber(project.netAvailableBalance)}
                                </p>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Virtual Balance</span>
                                <span class="font-semibold">₹${this.formatNumber(project.virtualBalance)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Loans Given</span>
                                <span class="font-semibold text-amber-600">₹${this.formatNumber(project.activeLoansGiven)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Loans Received</span>
                                <span class="font-semibold text-rose-600">₹${this.formatNumber(project.activeLoansReceived)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Advance Received</span>
                                <span class="font-semibold text-emerald-600">₹${this.formatNumber(project.advanceReceived)}</span>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-slate-200">
                            <button onclick="window.location.href='project.html?id=${project.projectId}'" class="btn-secondary text-xs w-full">
                                <i class="fas fa-external-link-alt mr-1"></i>View Project
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            async renderPaymentAllocations() {
                try {
                    // Get all payments that have allocations (both multi-project and auto-allocated single-project)
                    const allPayments = await Storage.clientPayments.getAll();
                    const allAllocations = await Storage.paymentAllocations.getAll();
                    
                    // Get payments that have allocations (either multi-project or auto-allocated)
                    const allocatedPaymentIds = [...new Set(allAllocations.map(a => a.paymentId))];
                    const allocatedPayments = allPayments.filter(p => 
                        p.isMultiProject || allocatedPaymentIds.includes(p.id)
                    );
                    
                    const container = document.getElementById('paymentAllocationsTable');
                    const emptyState = document.getElementById('paymentsEmpty');
                    
                    if (!allocatedPayments.length) {
                        container.innerHTML = '';
                        emptyState.classList.remove('hidden');
                        return;
                    }
                    
                    emptyState.classList.add('hidden');
                    
                    // Sort by date (newest first)
                    allocatedPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const rows = await Promise.all(allocatedPayments.map(async (payment) => {
                        // Get allocations for this payment
                        const allocations = await Storage.paymentAllocations.getByPayment(payment.id);
                        
                        // Get project names
                        const projectNames = await Promise.all(
                            allocations.map(async (alloc) => {
                                const project = await Storage.projects.getById(alloc.projectId);
                                return `${project ? project.name : 'Unknown'} (₹${this.formatNumber(alloc.amount)})`;
                            })
                        );
                        
                        // Determine payment type
                        const paymentType = payment.isMultiProject ? 'Multi-Project' : 'Auto-Allocated';
                        const typeClass = payment.isMultiProject ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
                        
                        return `
                            <tr>
                                <td class="text-slate-700">${this.formatDate(payment.date)}</td>
                                <td class="font-medium text-slate-800">${payment.from || 'N/A'}</td>
                                <td class="font-bold text-emerald-600">₹${this.formatNumber(payment.amount)}</td>
                                <td class="text-sm">
                                    <div class="space-y-1">
                                        ${projectNames.map(name => `<div class="px-2 py-1 bg-slate-100 rounded text-xs">${name}</div>`).join('')}
                                    </div>
                                </td>
                                <td class="text-slate-600">
                                    <div class="space-y-1">
                                        <div>${payment.method || 'N/A'}</div>
                                        <div class="px-2 py-1 ${typeClass} rounded text-xs font-medium">${paymentType}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex gap-1">
                                        <button class="action-btn bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200" onclick="FundsApp.viewPaymentDetails('${payment.id}')" title="View Details">
                                            <i class="fas fa-eye text-xs"></i>
                                        </button>
                                        <button class="action-btn bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ml-1" onclick="FundsApp.generatePaymentAllocationInvoice('${payment.id}')" title="Generate Invoice">
                                            <i class="fas fa-file-invoice text-xs"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }));
                    
                    container.innerHTML = rows.join('');
                    
                } catch (error) {
                    console.error('Error rendering payment allocations:', error);
                    document.getElementById('paymentAllocationsTable').innerHTML = 
                        '<tr><td colspan="6" class="text-center text-rose-500 py-4">Error loading payment allocations</td></tr>';
                }
            },

            async renderInterProjectLoans() {
                try {
                    // Get all cross-project transactions
                    const allTransactions = await Storage.crossProjectTransactions.getAll();
                    const activeLoans = allTransactions.filter(t => t.status === 'active');
                    const recentSettlements = await Storage.settlementRecords.getAll();
                    
                    // Render active loans
                    const activeContainer = document.getElementById('activeLoansContainer');
                    if (!activeLoans.length) {
                        activeContainer.innerHTML = `
                            <div class="text-center py-6">
                                <i class="fas fa-coins text-4xl text-slate-300 mb-3"></i>
                                <p class="text-slate-500 text-sm mb-2">No active loans</p>
                                <p class="text-xs text-slate-400">Cross-project expenses will create loans here</p>
                            </div>
                        `;
                    } else {
                        const loanCards = await Promise.all(activeLoans.map(async (loan) => {
                            const lenderProject = await Storage.projects.getById(loan.lenderProjectId);
                            const borrowerProject = await Storage.projects.getById(loan.borrowerProjectId);
                            const balance = loan.amount - (loan.settlementAmount || 0);
                            
                            return `
                                <div class="card p-3 border-l-4 border-amber-400">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="font-semibold text-slate-800 text-sm">
                                                ${lenderProject ? lenderProject.name : 'Unknown'} → ${borrowerProject ? borrowerProject.name : 'Unknown'}
                                            </p>
                                            <p class="text-xs text-slate-500">${this.formatDate(loan.date)}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-amber-600">₹${this.formatNumber(balance)}</p>
                                            <p class="text-xs text-slate-500">Outstanding</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-slate-600">${loan.description}</p>
                                    <div class="mt-2 flex justify-between text-xs">
                                        <span class="text-slate-500">Original: ₹${this.formatNumber(loan.amount)}</span>
                                        <span class="text-slate-500">Paid: ₹${this.formatNumber(loan.settlementAmount || 0)}</span>
                                    </div>
                                    <div class="mt-2 flex gap-1">
                                        <button onclick="FundsApp.generateCrossProjectExpenseInvoice('${loan.id}')" class="btn-primary text-xs px-2 py-1 rounded-lg shadow-sm hover:shadow-md transition-all">
                                            <i class="fas fa-file-invoice mr-1"></i>Invoice
                                        </button>
                                        <button onclick="FundsApp.repayLoan('${loan.id}')" class="btn-success text-xs px-2 py-1 rounded-lg shadow-sm hover:shadow-md transition-all">
                                            <i class="fas fa-money-bill-wave mr-1"></i>Repay
                                        </button>
                                        <button onclick="FundsApp.settleLoan('${loan.id}')" class="btn-secondary text-xs px-2 py-1 rounded-lg shadow-sm hover:shadow-md transition-all">
                                            <i class="fas fa-handshake mr-1"></i>Settle
                                        </button>
                                    </div>
                                </div>
                            `;
                        }));
                        
                        activeContainer.innerHTML = loanCards.join('');
                    }
                    
                    // Render recent settlements
                    const settlementsContainer = document.getElementById('recentSettlementsContainer');
                    if (!recentSettlements.length) {
                        settlementsContainer.innerHTML = `
                            <div class="text-center py-6">
                                <i class="fas fa-handshake text-4xl text-slate-300 mb-3"></i>
                                <p class="text-slate-500 text-sm mb-2">No settlements yet</p>
                                <p class="text-xs text-slate-400">Settlements will appear here when loans are repaid</p>
                            </div>
                        `;
                    } else {
                        // Sort by date (newest first) and take last 10
                        recentSettlements.sort((a, b) => new Date(b.settlementDate) - new Date(a.settlementDate));
                        const recentSettlementsLimited = recentSettlements.slice(0, 10);
                        
                        const settlementCards = await Promise.all(recentSettlementsLimited.map(async (settlement) => {
                            const lenderProject = await Storage.projects.getById(settlement.lenderProjectId);
                            const borrowerProject = await Storage.projects.getById(settlement.borrowerProjectId);
                            
                            return `
                                <div class="card p-3 border-l-4 border-emerald-400">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="font-semibold text-slate-800 text-sm">
                                                ${borrowerProject ? borrowerProject.name : 'Unknown'} → ${lenderProject ? lenderProject.name : 'Unknown'}
                                            </p>
                                            <p class="text-xs text-slate-500">${this.formatDate(settlement.settlementDate)}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-emerald-600">₹${this.formatNumber(settlement.settlementAmount)}</p>
                                            <p class="text-xs text-slate-500">Settled</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-slate-600">
                                        ${settlement.settlementType === 'auto' ? 'Auto-settled' : 'Manual settlement'}
                                    </p>
                                    <div class="mt-2">
                                        <button onclick="FundsApp.generateSettlementInvoice('${settlement.id}')" class="btn-primary text-xs px-3 py-1.5 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700">
                                            <i class="fas fa-file-invoice mr-1"></i>Invoice
                                        </button>
                                    </div>
                                </div>
                            `;
                        }));
                        
                        settlementsContainer.innerHTML = settlementCards.join('');
                    }
                    
                } catch (error) {
                    console.error('Error rendering inter-project loans:', error);
                    document.getElementById('activeLoansContainer').innerHTML = '<p class="text-rose-500 text-sm">Error loading loans</p>';
                    document.getElementById('recentSettlementsContainer').innerHTML = '<p class="text-rose-500 text-sm">Error loading settlements</p>';
                }
            },

            async renderUnallocatedFunds() {
                try {
                    const unallocatedFunds = await Storage.unallocatedFunds.getAll();
                    const container = document.getElementById('unallocatedFundsContainer');
                    
                    if (!unallocatedFunds.length) {
                        container.innerHTML = '<p class="text-slate-500 text-center py-8">No unallocated funds</p>';
                        return;
                    }
                    
                    const cards = unallocatedFunds.map(fund => `
                        <div class="card p-4 border-l-4 border-rose-400 mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-semibold text-slate-800">₹${this.formatNumber(fund.amount)}</p>
                                    <p class="text-sm text-slate-600">${fund.description}</p>
                                    <p class="text-xs text-slate-500">${this.formatDate(fund.date)}</p>
                                </div>
                                <button class="btn-primary text-sm px-3 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700" onclick="FundsApp.allocateUnallocatedFund('${fund.id}')">
                                    <i class="fas fa-check mr-1"></i>Allocate
                                </button>
                                <button class="btn-secondary text-sm ml-2 px-3 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 bg-gradient-to-r from-slate-500 to-gray-600 hover:from-slate-600 hover:to-gray-700 text-white" onclick="FundsApp.generateUnallocatedFundInvoice('${fund.id}')">
                                    <i class="fas fa-file-invoice mr-1"></i>Invoice
                                </button>
                            </div>
                        </div>
                    `);
                    
                    container.innerHTML = cards.join('');
                    
                } catch (error) {
                    console.error('Error rendering unallocated funds:', error);
                    document.getElementById('unallocatedFundsContainer').innerHTML = 
                        '<p class="text-rose-500 text-center py-8">Error loading unallocated funds</p>';
                }
            },

            openPaymentAllocationModal() {
                this.populateProjectDropdowns();
                this.resetAllocationForm();
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('paymentAllocationModal').classList.remove('hidden');
                document.getElementById('paymentAllocationModal').classList.add('active');
            },

            openCrossProjectExpenseModal() {
                this.populateProjectDropdowns();
                this.resetExpenseForm();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('crossProjectExpenseModal').classList.remove('hidden');
                document.getElementById('crossProjectExpenseModal').classList.add('active');
            },

            populateProjectDropdowns() {
                const beneficiarySelect = document.getElementById('beneficiaryProject');
                if (beneficiarySelect) {
                    beneficiarySelect.innerHTML = '<option value="">Select project that benefits from this expense</option>' +
                        this.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
            },

            resetAllocationForm() {
                this.allocationCount = 0;
                document.getElementById('allocationsList').innerHTML = '';
                this.addAllocationRow();
                this.updateAllocationCalculations();
            },

            resetExpenseForm() {
                this.paymentSourceCount = 0;
                document.getElementById('paymentSourcesList').innerHTML = '';
                this.addPaymentSourceRow();
                this.updatePaymentSourceCalculations();
            },

            addAllocationRow() {
                const container = document.getElementById('allocationsList');
                const rowId = ++this.allocationCount;
                
                const row = document.createElement('div');
                row.className = 'allocation-row grid grid-cols-1 md:grid-cols-4 gap-3 p-3 bg-slate-50 rounded-lg';
                row.innerHTML = `
                    <select class="form-input project-select" required>
                        <option value="">Select Project</option>
                        ${this.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                    <input type="number" class="form-input allocation-amount" placeholder="Amount" min="1" step="0.01" required>
                    <input type="text" class="form-input" placeholder="Description (optional)">
                    <button type="button" class="btn-danger text-sm" onclick="this.parentElement.remove(); FundsApp.updateAllocationCalculations();">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                container.appendChild(row);
                
                // Add event listener for amount changes
                row.querySelector('.allocation-amount').addEventListener('input', () => this.updateAllocationCalculations());
            },

            addPaymentSourceRow() {
                const container = document.getElementById('paymentSourcesList');
                const rowId = ++this.paymentSourceCount;
                
                const row = document.createElement('div');
                row.className = 'payment-source-row grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-slate-50 rounded-lg';
                row.innerHTML = `
                    <select class="form-input project-select" required>
                        <option value="">Select Paying Project</option>
                        ${this.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                    <input type="number" class="form-input source-amount" placeholder="Amount" min="1" step="0.01" required>
                    <button type="button" class="btn-danger text-sm" onclick="this.parentElement.remove(); FundsApp.updatePaymentSourceCalculations();">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                container.appendChild(row);
                
                // Add event listener for amount changes
                row.querySelector('.source-amount').addEventListener('input', () => this.updatePaymentSourceCalculations());
            },

            updateAllocationCalculations() {
                const totalAmount = parseFloat(document.getElementById('totalPaymentAmount').value) || 0;
                const allocationAmounts = Array.from(document.querySelectorAll('.allocation-amount'))
                    .map(input => parseFloat(input.value) || 0);
                
                const totalAllocated = allocationAmounts.reduce((sum, amount) => sum + amount, 0);
                const remaining = totalAmount - totalAllocated;
                
                document.getElementById('totalAllocated').textContent = `₹${this.formatNumber(totalAllocated)}`;
                document.getElementById('remainingAmount').textContent = `₹${this.formatNumber(remaining)}`;
                document.getElementById('remainingAmount').className = `font-bold ${remaining === 0 ? 'text-emerald-600' : 'text-rose-600'}`;
            },

            updatePaymentSourceCalculations() {
                const totalAmount = parseFloat(document.getElementById('expenseAmount').value) || 0;
                const sourceAmounts = Array.from(document.querySelectorAll('.source-amount'))
                    .map(input => parseFloat(input.value) || 0);
                
                const totalPaid = sourceAmounts.reduce((sum, amount) => sum + amount, 0);
                const remaining = totalAmount - totalPaid;
                
                document.getElementById('totalPaid').textContent = `₹${this.formatNumber(totalPaid)}`;
                document.getElementById('remainingExpense').textContent = `₹${this.formatNumber(remaining)}`;
                document.getElementById('remainingExpense').className = `font-bold ${remaining === 0 ? 'text-emerald-600' : 'text-rose-600'}`;
            },

            async handlePaymentAllocation(e) {
                e.preventDefault();
                
                try {
                    // Collect form data
                    const totalAmount = parseFloat(document.getElementById('totalPaymentAmount').value);
                    const paymentDate = document.getElementById('paymentDate').value;
                    const from = document.getElementById('paymentFrom').value.trim();
                    const receivedBy = document.getElementById('paymentReceivedBy').value.trim();
                    const method = document.getElementById('paymentMethod').value;
                    const notes = document.getElementById('paymentNotes').value.trim();
                    
                    // Collect allocations
                    const allocationRows = document.querySelectorAll('.allocation-row');
                    const allocations = [];
                    
                    for (const row of allocationRows) {
                        const projectId = row.querySelector('.project-select').value;
                        const amount = parseFloat(row.querySelector('.allocation-amount').value);
                        const description = row.querySelector('input[type="text"]').value.trim();
                        
                        if (projectId && amount > 0) {
                            allocations.push({
                                projectId,
                                amount,
                                description: description || `Payment allocation from ${from}`
                            });
                        }
                    }
                    
                    if (!allocations.length) {
                        this.showToast('Please add at least one project allocation', 'error');
                        return;
                    }
                    
                    // Validate total allocation
                    const totalAllocated = allocations.reduce((sum, alloc) => sum + alloc.amount, 0);
                    if (Math.abs(totalAllocated - totalAmount) > 0.01) {
                        this.showToast(`Total allocated (₹${this.formatNumber(totalAllocated)}) must equal payment amount (₹${this.formatNumber(totalAmount)})`, 'error');
                        return;
                    }
                    
                    // Show loading
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                    submitBtn.disabled = true;
                    
                    // Allocate payment using FundManagement
                    await FundManagement.allocatePayment({
                        totalAmount,
                        allocations,
                        paymentDate,
                        receivedBy,
                        from,
                        method,
                        notes
                    });
                    
                    this.showToast('Payment allocated successfully!', 'success');
                    this.closeAllModals();
                    await this.renderAll();
                    
                } catch (error) {
                    console.error('Error allocating payment:', error);
                    this.showToast('Error allocating payment: ' + error.message, 'error');
                } finally {
                    // Reset button
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = 'Allocate Payment';
                        submitBtn.disabled = false;
                    }
                }
            },

            async handleCrossProjectExpense(e) {
                e.preventDefault();
                
                try {
                    // Collect form data
                    const beneficiaryProjectId = document.getElementById('beneficiaryProject').value;
                    const expenseType = document.getElementById('expenseType').value;
                    const totalAmount = parseFloat(document.getElementById('expenseAmount').value);
                    const description = document.getElementById('expenseDescription').value.trim();
                    const date = document.getElementById('expenseDate').value;
                    
                    if (!beneficiaryProjectId) {
                        this.showToast('Please select the beneficiary project', 'error');
                        return;
                    }
                    
                    // Collect payment sources
                    const sourceRows = document.querySelectorAll('.payment-source-row');
                    const paymentSources = [];
                    
                    for (const row of sourceRows) {
                        const projectId = row.querySelector('.project-select').value;
                        const amount = parseFloat(row.querySelector('.source-amount').value);
                        
                        if (projectId && amount > 0) {
                            paymentSources.push({ projectId, amount });
                        }
                    }
                    
                    if (!paymentSources.length) {
                        this.showToast('Please add at least one payment source', 'error');
                        return;
                    }
                    
                    // Validate total payment
                    const totalPaid = paymentSources.reduce((sum, source) => sum + source.amount, 0);
                    if (Math.abs(totalPaid - totalAmount) > 0.01) {
                        this.showToast(`Total paid (₹${this.formatNumber(totalPaid)}) must equal expense amount (₹${this.formatNumber(totalAmount)})`, 'error');
                        return;
                    }
                    
                    // Show loading
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                    submitBtn.disabled = true;
                    
                    // Prepare expense details based on type
                    let expenseDetails;
                    if (expenseType === 'material') {
                        expenseDetails = {
                            name: description,
                            category: 'Cross-Project',
                            quantity: 1,
                            unit: 'item',
                            rate: totalAmount,
                            status: 'used',
                            date: date,
                            supplier: 'Cross-Project Purchase',
                            paidAmount: totalAmount
                        };
                    } else if (expenseType === 'labour') {
                        expenseDetails = {
                            workerName: 'Cross-Project Worker',
                            role: 'Cross-Project',
                            dailyWage: totalAmount,
                            totalAmount: totalAmount,
                            startDate: date,
                            endDate: date,
                            paidAmount: totalAmount
                        };
                    } else {
                        expenseDetails = {
                            description: description,
                            category: 'Cross-Project',
                            amount: totalAmount,
                            date: date
                        };
                    }
                    
                    // Record cross-project expense
                    await FundManagement.recordCrossProjectExpense({
                        beneficiaryProjectId,
                        paymentSources,
                        expenseDetails,
                        expenseType
                    });
                    
                    this.showToast('Cross-project expense recorded successfully!', 'success');
                    this.closeAllModals();
                    await this.renderAll();
                    
                } catch (error) {
                    console.error('Error recording cross-project expense:', error);
                    this.showToast('Error recording expense: ' + error.message, 'error');
                } finally {
                    // Reset button
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = 'Record Expense';
                        submitBtn.disabled = false;
                    }
                }
            },

            closeAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.add('hidden');
                    modal.classList.remove('active');
                });
            },

            formatNumber(num) {
                if (num === null || num === undefined || isNaN(num)) return '0';
                return new Intl.NumberFormat('en-IN').format(num);
            },

            formatDate(dateStr) {
                return new Date(dateStr).toLocaleDateString('en-IN', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });
            },

            async viewPaymentDetails(paymentId) {
                try {
                    const payment = await Storage.clientPayments.getById(paymentId);
                    const allocations = await Storage.paymentAllocations.getByPayment(paymentId);
                    
                    let details = `Payment Details:\n\n`;
                    details += `Amount: ₹${this.formatNumber(payment.amount)}\n`;
                    details += `Date: ${this.formatDate(payment.date)}\n`;
                    details += `From: ${payment.from}\n`;
                    details += `Received By: ${payment.receivedBy}\n`;
                    details += `Method: ${payment.method}\n\n`;
                    details += `Project Allocations:\n`;
                    
                    for (const alloc of allocations) {
                        const project = await Storage.projects.getById(alloc.projectId);
                        details += `• ${project ? project.name : 'Unknown'}: ₹${this.formatNumber(alloc.amount)}\n`;
                    }
                    
                    alert(details);
                } catch (error) {
                    console.error('Error viewing payment details:', error);
                    this.showToast('Error loading payment details', 'error');
                }
            },

            async allocateUnallocatedFund(fundId) {
                // Open payment allocation modal with pre-filled data
                try {
                    const fund = await Storage.unallocatedFunds.getById(fundId);
                    if (fund) {
                        this.openPaymentAllocationModal();
                        document.getElementById('totalPaymentAmount').value = fund.amount;
                        document.getElementById('paymentFrom').value = fund.description;
                        document.getElementById('paymentDate').value = fund.date;
                        this.updateAllocationCalculations();
                    }
                } catch (error) {
                    console.error('Error loading unallocated fund:', error);
                    this.showToast('Error loading fund details', 'error');
                }
            },

            async reconcileSystem() {
                try {
                    const status = await FundManagement.getOverallFundStatus();
                    
                    let report = `FUND MANAGEMENT SYSTEM RECONCILIATION\n`;
                    report += `==========================================\n\n`;
                    report += `Total Virtual Balance: ₹${this.formatNumber(status.totalVirtualBalance)}\n`;
                    report += `Total Active Loans: ₹${this.formatNumber(status.totalActiveLoans)}\n`;
                    report += `System Balanced: ${status.isBalanced ? 'YES ✓' : 'NO ⚠'}\n\n`;
                    
                    report += `PROJECT BREAKDOWN:\n`;
                    report += `------------------\n`;
                    for (const project of status.projectSummaries) {
                        report += `${project.projectName}:\n`;
                        report += `  Virtual Balance: ₹${this.formatNumber(project.virtualBalance)}\n`;
                        report += `  Loans Given: ₹${this.formatNumber(project.activeLoansGiven)}\n`;
                        report += `  Loans Received: ₹${this.formatNumber(project.activeLoansReceived)}\n`;
                        report += `  Net Available: ₹${this.formatNumber(project.netAvailableBalance)}\n\n`;
                    }
                    
                    if (!status.isBalanced) {
                        report += `⚠ SYSTEM UNBALANCED!\n`;
                        report += `This indicates a data inconsistency that needs investigation.\n`;
                    }
                    
                    // Show in a modal or alert
                    alert(report);
                    
                } catch (error) {
                    console.error('Error reconciling system:', error);
                    this.showToast('Error during reconciliation', 'error');
                }
            },

            async generateCrossProjectExpenseInvoice(transactionId) {
                try {
                    this.showToast('Generating cross-project expense invoice...', 'info');
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Get transaction data
                    const transaction = await Storage.crossProjectTransactions.getById(transactionId);
                    if (!transaction) {
                        throw new Error('Transaction not found');
                    }
                    
                    const lenderProject = await Storage.projects.getById(transaction.lenderProjectId);
                    const borrowerProject = await Storage.projects.getById(transaction.borrowerProjectId);
                    
                    let y = 20;
                    
                    // Header
                    doc.setFontSize(24);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Maviya Constructions', 105, y, { align: 'center' });
                    y += 12;
                    
                    doc.setFontSize(18);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Cross-Project Expense Invoice', 105, y, { align: 'center' });
                    y += 20;
                    
                    // Invoice Info Box
                    doc.setFillColor(245, 158, 11);
                    doc.roundedRect(20, y, 170, 20, 3, 3, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`Invoice #: CPE-${transaction.id.substring(0, 8).toUpperCase()}`, 30, y + 6);
                    doc.text(`Date: ${this.formatDate(transaction.date)}`, 130, y + 6);
                    doc.text(`Amount: Rs. ${this.formatNumber(transaction.amount)}`, 30, y + 12);
                    doc.text(`Type: ${transaction.expenseType}`, 130, y + 12);
                    doc.text(`Status: ${transaction.status}`, 30, y + 18);
                    y += 30;
                    
                    // Transaction Details
                    doc.setFontSize(12);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Transaction Details', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.text(`Beneficiary Project: ${borrowerProject ? borrowerProject.name : 'Unknown'}`, 20, y);
                    y += 6;
                    doc.text(`Paid by Project: ${lenderProject ? lenderProject.name : 'Unknown'}`, 20, y);
                    y += 6;
                    doc.text(`Description: ${transaction.description}`, 20, y);
                    y += 6;
                    doc.text(`Expense Type: ${transaction.expenseType}`, 20, y);
                    y += 15;
                    
                    // Payment Sources Table
                    if (transaction.paymentSources && transaction.paymentSources.length > 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(16, 185, 129);
                        doc.text('Payment Sources', 20, y);
                        y += 8;
                        
                        const paymentData = await Promise.all(transaction.paymentSources.map(async (source) => {
                            const sourceProject = await Storage.projects.getById(source.projectId);
                            return [
                                sourceProject ? sourceProject.name : 'Unknown',
                                `Rs. ${this.formatNumber(source.amount)}`,
                                source.description || 'Payment source'
                            ];
                        }));
                        
                        doc.autoTable({
                            startY: y,
                            head: [['Source Project', 'Amount', 'Description']],
                            body: paymentData,
                            theme: 'striped',
                            headStyles: { fillColor: [16, 185, 129] },
                            margin: { left: 20, right: 20 },
                            styles: { fontSize: 10 }
                        });
                        
                        y = doc.lastAutoTable.finalY + 15;
                    }
                    
                    // Settlement Information
                    if (transaction.settlementAmount > 0) {
                        doc.setFillColor(241, 245, 249);
                        doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
                        y += 8;
                        doc.setFontSize(12);
                        doc.setTextColor(16, 185, 129);
                        doc.text('Settlement Information', 105, y, { align: 'center' });
                        y += 8;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(51, 65, 85);
                        doc.text(`Original Amount: Rs. ${this.formatNumber(transaction.amount)}`, 30, y);
                        doc.text(`Settled Amount: Rs. ${this.formatNumber(transaction.settlementAmount)}`, 130, y);
                        y += 6;
                        const balance = transaction.amount - transaction.settlementAmount;
                        doc.text(`Outstanding Balance: Rs. ${this.formatNumber(balance)}`, 30, y);
                        y += 15;
                    }
                    
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Maviya Constructions - Cross-Project Expense Invoice', 20, 280);
                    doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 190, 280, { align: 'right' });
                    
                    // Save
                    const fileName = `Cross_Project_Expense_Invoice_${transaction.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    this.showToast('Cross-project expense invoice downloaded!', 'success');
                    
                } catch (error) {
                    console.error('Error generating cross-project expense invoice:', error);
                    this.showToast('Error generating invoice: ' + error.message, 'error');
                }
            },

            async generateUnallocatedFundInvoice(fundId) {
                try {
                    this.showToast('Generating unallocated fund invoice...', 'info');
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Get fund data
                    const fund = await Storage.unallocatedFunds.getById(fundId);
                    if (!fund) {
                        throw new Error('Unallocated fund record not found');
                    }
                    
                    let y = 20;
                    
                    // Header
                    doc.setFontSize(24);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Maviya Constructions', 105, y, { align: 'center' });
                    y += 12;
                    
                    doc.setFontSize(18);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Unallocated Fund Invoice', 105, y, { align: 'center' });
                    y += 20;
                    
                    // Invoice Info Box
                    doc.setFillColor(239, 68, 68);
                    doc.roundedRect(20, y, 170, 15, 3, 3, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`Invoice #: UF-${fund.id.substring(0, 8).toUpperCase()}`, 30, y + 6);
                    doc.text(`Date: ${this.formatDate(fund.date)}`, 130, y + 6);
                    doc.text(`Amount: Rs. ${this.formatNumber(fund.amount)}`, 30, y + 12);
                    y += 25;
                    
                    // Fund Details
                    doc.setFontSize(12);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Unallocated Fund Details', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.text(`Amount: Rs. ${this.formatNumber(fund.amount)}`, 20, y);
                    y += 6;
                    doc.text(`Date Received: ${this.formatDate(fund.date)}`, 20, y);
                    y += 6;
                    doc.text(`Description: ${fund.description}`, 20, y);
                    y += 6;
                    if (fund.source) {
                        doc.text(`Source: ${fund.source}`, 20, y);
                        y += 6;
                    }
                    if (fund.notes) {
                        doc.text(`Notes: ${fund.notes}`, 20, y);
                        y += 6;
                    }
                    y += 15;
                    
                    // Status Information
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(20, y, 170, 20, 3, 3, 'F');
                    y += 8;
                    doc.setFontSize(12);
                    doc.setTextColor(239, 68, 68);
                    doc.text('Fund Status', 105, y, { align: 'center' });
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Status: Unallocated - Awaiting Project Assignment', 30, y);
                    y += 6;
                    doc.text('Action Required: Allocate to specific project(s)', 30, y);
                    y += 20;
                    
                    // Warning Notice
                    doc.setFillColor(254, 243, 199);
                    doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
                    y += 8;
                    doc.setFontSize(11);
                    doc.setTextColor(180, 83, 9);
                    doc.text('⚠ NOTICE', 105, y, { align: 'center' });
                    y += 6;
                    doc.setFontSize(9);
                    doc.text('This fund is currently unallocated and not assigned to any specific project.', 30, y);
                    y += 4;
                    doc.text('Please allocate this fund to appropriate project(s) for proper accounting.', 30, y);
                    y += 20;
                    
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Maviya Constructions - Unallocated Fund Invoice', 20, 280);
                    doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 190, 280, { align: 'right' });
                    
                    // Save
                    const fileName = `Unallocated_Fund_Invoice_${fund.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    this.showToast('Unallocated fund invoice downloaded!', 'success');
                    
                } catch (error) {
                    console.error('Error generating unallocated fund invoice:', error);
                    this.showToast('Error generating invoice: ' + error.message, 'error');
                }
            },

            async generateSettlementInvoice(settlementId) {
                try {
                    this.showToast('Generating settlement invoice...', 'info');
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Get settlement data
                    const settlement = await Storage.settlementRecords.getById(settlementId);
                    if (!settlement) {
                        throw new Error('Settlement record not found');
                    }
                    
                    const lenderProject = await Storage.projects.getById(settlement.lenderProjectId);
                    const borrowerProject = await Storage.projects.getById(settlement.borrowerProjectId);
                    
                    let y = 20;
                    
                    // Header
                    doc.setFontSize(24);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Maviya Constructions', 105, y, { align: 'center' });
                    y += 12;
                    
                    doc.setFontSize(18);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Loan Settlement Invoice', 105, y, { align: 'center' });
                    y += 20;
                    
                    // Invoice Info Box
                    doc.setFillColor(16, 185, 129);
                    doc.roundedRect(20, y, 170, 20, 3, 3, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`Invoice #: LS-${settlement.id.substring(0, 8).toUpperCase()}`, 30, y + 6);
                    doc.text(`Date: ${this.formatDate(settlement.settlementDate)}`, 130, y + 6);
                    doc.text(`Amount: Rs. ${this.formatNumber(settlement.settlementAmount)}`, 30, y + 12);
                    doc.text(`Type: ${settlement.settlementType}`, 130, y + 12);
                    y += 30;
                    
                    // Settlement Details
                    doc.setFontSize(12);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Settlement Details', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.text(`From (Borrower): ${borrowerProject ? borrowerProject.name : 'Unknown'}`, 20, y);
                    y += 6;
                    doc.text(`To (Lender): ${lenderProject ? lenderProject.name : 'Unknown'}`, 20, y);
                    y += 6;
                    doc.text(`Settlement Type: ${settlement.settlementType === 'auto' ? 'Automatic Settlement' : 'Manual Settlement'}`, 20, y);
                    y += 6;
                    doc.text(`Settlement Date: ${this.formatDate(settlement.settlementDate)}`, 20, y);
                    y += 15;
                    
                    // Original Transaction Details (if available)
                    if (settlement.originalTransactionId) {
                        const originalTransaction = await Storage.crossProjectTransactions.getById(settlement.originalTransactionId);
                        if (originalTransaction) {
                            doc.setFillColor(241, 245, 249);
                            doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
                            y += 8;
                            doc.setFontSize(12);
                            doc.setTextColor(14, 165, 233);
                            doc.text('Original Transaction Details', 105, y, { align: 'center' });
                            y += 8;
                            
                            doc.setFontSize(10);
                            doc.setTextColor(51, 65, 85);
                            doc.text(`Original Amount: Rs. ${this.formatNumber(originalTransaction.amount)}`, 30, y);
                            doc.text(`Transaction Date: ${this.formatDate(originalTransaction.date)}`, 130, y);
                            y += 6;
                            doc.text(`Description: ${originalTransaction.description}`, 30, y);
                            y += 6;
                            doc.text(`Expense Type: ${originalTransaction.expenseType}`, 30, y);
                            y += 15;
                        }
                    }
                    
                    // Settlement Summary
                    doc.setFillColor(16, 185, 129, 0.1);
                    doc.roundedRect(20, y, 170, 20, 3, 3, 'F');
                    y += 8;
                    doc.setFontSize(12);
                    doc.setTextColor(16, 185, 129);
                    doc.text('Settlement Summary', 105, y, { align: 'center' });
                    y += 8;
                    
                    doc.setFontSize(11);
                    doc.setTextColor(51, 65, 85);
                    doc.text(`Settlement Amount: Rs. ${this.formatNumber(settlement.settlementAmount)}`, 30, y);
                    doc.text(`Status: Completed`, 130, y);
                    y += 20;
                    
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Maviya Constructions - Loan Settlement Invoice', 20, 280);
                    doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 190, 280, { align: 'right' });
                    
                    // Save
                    const fileName = `Loan_Settlement_Invoice_${settlement.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    this.showToast('Settlement invoice downloaded!', 'success');
                    
                } catch (error) {
                    console.error('Error generating settlement invoice:', error);
                    this.showToast('Error generating invoice: ' + error.message, 'error');
                }
            },

            async repayLoan(transactionId) {
                try {
                    const transaction = await Storage.crossProjectTransactions.getById(transactionId);
                    if (!transaction) {
                        throw new Error('Transaction not found');
                    }
                    
                    const lenderProject = await Storage.projects.getById(transaction.lenderProjectId);
                    const borrowerProject = await Storage.projects.getById(transaction.borrowerProjectId);
                    const balance = transaction.amount - (transaction.settlementAmount || 0);
                    
                    // Create a modal for loan repayment
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="modal-content rounded-xl w-full max-w-md mx-4">
                            <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-slate-800">Repay Loan</h3>
                                <button class="close-modal text-slate-400 hover:text-sky-600 transition">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="p-5 space-y-4">
                                <div class="bg-slate-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-slate-800 mb-2">Loan Details</h4>
                                    <p class="text-sm text-slate-600">From: ${lenderProject ? lenderProject.name : 'Unknown'}</p>
                                    <p class="text-sm text-slate-600">To: ${borrowerProject ? borrowerProject.name : 'Unknown'}</p>
                                    <p class="text-sm text-slate-600">Original Amount: ₹${this.formatNumber(transaction.amount)}</p>
                                    <p class="text-sm text-slate-600">Already Paid: ₹${this.formatNumber(transaction.settlementAmount || 0)}</p>
                                    <p class="text-sm font-semibold text-rose-600">Outstanding: ₹${this.formatNumber(balance)}</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Repayment Amount (₹)</label>
                                    <input type="number" id="repaymentAmount" class="form-input" min="1" max="${balance}" step="0.01" placeholder="Enter amount to repay">
                                    <p class="text-xs text-slate-500 mt-1">Maximum: ₹${this.formatNumber(balance)}</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Payment Method</label>
                                    <select id="repaymentMethod" class="form-input">
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="UPI">UPI</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Adjustment">Adjustment</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Notes (Optional)</label>
                                    <textarea id="repaymentNotes" class="form-input" rows="2" placeholder="Payment notes or reference"></textarea>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button class="cancel-repayment flex-1 btn-secondary">Cancel</button>
                                    <button class="confirm-repayment flex-1 btn-primary">Record Repayment</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Event listeners
                    modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
                    modal.querySelector('.cancel-repayment').addEventListener('click', () => modal.remove());
                    modal.querySelector('.confirm-repayment').addEventListener('click', async () => {
                        const amount = parseFloat(document.getElementById('repaymentAmount').value);
                        const method = document.getElementById('repaymentMethod').value;
                        const notes = document.getElementById('repaymentNotes').value;
                        
                        if (!amount || amount <= 0 || amount > balance) {
                            this.showToast('Please enter a valid repayment amount', 'error');
                            return;
                        }
                        
                        try {
                            // Record the repayment
                            await FundManagement.settleCrossProjectTransaction(transactionId, amount, 'manual', {
                                method: method,
                                notes: notes,
                                repaymentDate: new Date().toISOString()
                            });
                            
                            modal.remove();
                            this.showToast('Loan repayment recorded successfully!', 'success');
                            await this.renderInterProjectLoans();
                            await this.renderOverallStatus();
                            
                        } catch (error) {
                            console.error('Error recording repayment:', error);
                            this.showToast('Error recording repayment: ' + error.message, 'error');
                        }
                    });
                    
                } catch (error) {
                    console.error('Error opening repayment modal:', error);
                    this.showToast('Error opening repayment modal: ' + error.message, 'error');
                }
            },

            async settleLoan(transactionId) {
                try {
                    const transaction = await Storage.crossProjectTransactions.getById(transactionId);
                    if (!transaction) {
                        throw new Error('Transaction not found');
                    }
                    
                    const balance = transaction.amount - (transaction.settlementAmount || 0);
                    const settlementAmount = prompt(`Enter settlement amount (Outstanding: Rs. ${this.formatNumber(balance)}):`);
                    
                    if (!settlementAmount || isNaN(settlementAmount) || parseFloat(settlementAmount) <= 0) {
                        return;
                    }
                    
                    const amount = parseFloat(settlementAmount);
                    if (amount > balance) {
                        this.showToast('Settlement amount cannot exceed outstanding balance', 'error');
                        return;
                    }
                    
                    await FundManagement.settleCrossProjectTransaction(transactionId, amount, 'manual');
                    this.showToast('Loan settled successfully!', 'success');
                    await this.renderInterProjectLoans();
                    
                } catch (error) {
                    console.error('Error settling loan:', error);
                    this.showToast('Error settling loan: ' + error.message, 'error');
                }
            },

            async generatePaymentAllocationInvoice(paymentId) {
                try {
                    this.showToast('Generating payment allocation invoice...', 'info');
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Get payment and allocation data
                    const payment = await Storage.clientPayments.getById(paymentId);
                    const allocations = await Storage.paymentAllocations.getByPayment(paymentId);
                    
                    if (!payment || !allocations.length) {
                        throw new Error('Payment or allocation data not found');
                    }
                    
                    let y = 20;
                    
                    // Header
                    doc.setFontSize(24);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Maviya Constructions', 105, y, { align: 'center' });
                    y += 12;
                    
                    doc.setFontSize(18);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Payment Allocation Invoice', 105, y, { align: 'center' });
                    y += 20;
                    
                    // Invoice Info Box
                    doc.setFillColor(14, 165, 233);
                    doc.roundedRect(20, y, 170, 15, 3, 3, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`Invoice #: PA-${payment.id.substring(0, 8).toUpperCase()}`, 30, y + 6);
                    doc.text(`Date: ${this.formatDate(payment.date)}`, 130, y + 6);
                    doc.text(`Amount: Rs. ${this.formatNumber(payment.amount)}`, 30, y + 12);
                    doc.text(`From: ${payment.from}`, 130, y + 12);
                    y += 25;
                    
                    // Payment Details
                    doc.setFontSize(12);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Payment Details', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.text(`Payment Method: ${payment.method}`, 20, y);
                    doc.text(`Received By: ${payment.receivedBy}`, 120, y);
                    y += 6;
                    if (payment.notes) {
                        doc.text(`Notes: ${payment.notes}`, 20, y);
                        y += 6;
                    }
                    y += 10;
                    
                    // Allocation Table
                    doc.setFontSize(12);
                    doc.setTextColor(16, 185, 129);
                    doc.text('Project Allocations', 20, y);
                    y += 8;
                    
                    const allocationData = await Promise.all(allocations.map(async (alloc) => {
                        const project = await Storage.projects.getById(alloc.projectId);
                        return [
                            project ? project.name : 'Unknown Project',
                            `Rs. ${this.formatNumber(alloc.amount)}`,
                            alloc.description || 'Payment allocation',
                            this.formatDate(alloc.date)
                        ];
                    }));
                    
                    doc.autoTable({
                        startY: y,
                        head: [['Project', 'Amount', 'Description', 'Date']],
                        body: allocationData,
                        theme: 'striped',
                        headStyles: { fillColor: [16, 185, 129] },
                        margin: { left: 20, right: 20 },
                        styles: { fontSize: 10 }
                    });
                    
                    y = doc.lastAutoTable.finalY + 15;
                    
                    // Summary
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(20, y, 170, 20, 3, 3, 'F');
                    y += 8;
                    doc.setFontSize(12);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Payment Summary', 105, y, { align: 'center' });
                    y += 8;
                    
                    const totalAllocated = allocations.reduce((sum, alloc) => sum + alloc.amount, 0);
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    doc.text(`Total Payment: Rs. ${this.formatNumber(payment.amount)}`, 30, y);
                    doc.text(`Total Allocated: Rs. ${this.formatNumber(totalAllocated)}`, 130, y);
                    y += 20;
                    
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Maviya Constructions - Payment Allocation Invoice', 20, 280);
                    doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 190, 280, { align: 'right' });
                    
                    // Save
                    const fileName = `Payment_Allocation_Invoice_${payment.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    this.showToast('Payment allocation invoice downloaded!', 'success');
                    
                } catch (error) {
                    console.error('Error generating payment allocation invoice:', error);
                    this.showToast('Error generating invoice: ' + error.message, 'error');
                }
            },

            async generateFundUnderstandingGuide() {
                try {
                    this.showToast('Generating fund management understanding guide...', 'info');
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    let y = 20;
                    
                    // ===== COVER PAGE =====
                    doc.setFontSize(28);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Maviya Constructions', 105, y, { align: 'center' });
                    y += 15;
                    
                    doc.setFontSize(20);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Fund Management System', 105, y, { align: 'center' });
                    y += 8;
                    doc.text('Complete Understanding Guide', 105, y, { align: 'center' });
                    y += 20;
                    
                    // Date box
                    doc.setFillColor(14, 165, 233);
                    doc.roundedRect(20, y, 170, 12, 3, 3, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, 105, y + 8, { align: 'center' });
                    y += 30;
                    
                    // Introduction
                    doc.setFontSize(14);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Introduction', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    const introText = [
                        'This comprehensive guide explains the Fund Management System designed for',
                        'Maviya Constructions to handle multi-project financial operations with a',
                        'single bank account. The system provides virtual project wallets, cross-project',
                        'expense tracking, and automated settlement mechanisms.'
                    ];
                    
                    introText.forEach(line => {
                        doc.text(line, 20, y);
                        y += 5;
                    });
                    y += 10;
                    
                    // ===== PAGE 2: SYSTEM OVERVIEW =====
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(18);
                    doc.setTextColor(14, 165, 233);
                    doc.text('System Overview', 20, y);
                    y += 15;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Core Problem Solved:', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    const problemText = [
                        '• Multiple construction projects running simultaneously',
                        '• All client payments deposited into single bank account',
                        '• Difficulty tracking which payments belong to which project',
                        '• Cross-project expenses (materials bought for Project A using Project B funds)',
                        '• Need for accurate project-wise financial records and audit trails'
                    ];
                    
                    problemText.forEach(line => {
                        doc.text(line, 25, y);
                        y += 6;
                    });
                    y += 10;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(16, 185, 129);
                    doc.text('Solution Approach:', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    const solutionText = [
                        '• Virtual Project Wallets: Each project has a virtual balance',
                        '• Payment Allocation: Incoming payments allocated to specific projects',
                        '• Cross-Project Loans: Track when one project pays for another',
                        '• Automatic Settlement: Auto-repay loans when projects receive funds',
                        '• Complete Audit Trail: Every transaction recorded with full history'
                    ];
                    
                    solutionText.forEach(line => {
                        doc.text(line, 25, y);
                        y += 6;
                    });
                    y += 15;
                    
                    // ===== PAGE 3: VIRTUAL WALLETS EXPLAINED =====
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Virtual Project Wallets', 20, y);
                    y += 12;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    const walletText = [
                        'Each project maintains a virtual wallet that tracks:',
                        '',
                        '1. VIRTUAL BALANCE: Money allocated to this project from client payments',
                        '   - When client pays Rs. 50,000 for Project A, virtual balance increases',
                        '   - This money is "earmarked" for Project A expenses',
                        '',
                        '2. LOANS GIVEN: Money this project has lent to other projects',
                        '   - Project A buys materials worth Rs. 10,000 for Project B',
                        '   - Project A virtual balance decreases, but creates a loan receivable',
                        '',
                        '3. LOANS RECEIVED: Money this project owes to other projects',
                        '   - Project B received materials worth Rs. 10,000 paid by Project A',
                        '   - Project B has a loan payable to Project A',
                        '',
                        '4. NET AVAILABLE BALANCE: Actual money available for project use',
                        '   - Formula: Virtual Balance + Loans Received - Loans Given',
                        '   - This is the real money available for project expenses'
                    ];
                    
                    walletText.forEach(line => {
                        if (line === '') {
                            y += 3;
                        } else if (line.match(/^\\d+\\./)) {
                            doc.setFontSize(10);
                            doc.setTextColor(16, 185, 129);
                            doc.text(line, 20, y);
                            y += 6;
                        } else if (line.startsWith('   -')) {
                            doc.setFontSize(9);
                            doc.setTextColor(75, 85, 99);
                            doc.text(line, 25, y);
                            y += 5;
                        } else {
                            doc.setFontSize(10);
                            doc.setTextColor(51, 65, 85);
                            doc.text(line, 20, y);
                            y += 6;
                        }
                    });
                    
                    // ===== PAGE 4: PAYMENT ALLOCATION PROCESS =====
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Payment Allocation Process', 20, y);
                    y += 12;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(16, 185, 129);
                    doc.text('Step-by-Step Process:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    const allocationSteps = [
                        'STEP 1: Client Payment Received',
                        '• Client pays Rs. 1,00,000 into company bank account',
                        '• Payment could be for multiple projects or advance payment',
                        '',
                        'STEP 2: Payment Allocation',
                        '• User allocates payment across projects:',
                        '  - Project A: Rs. 60,000 (for ongoing work)',
                        '  - Project B: Rs. 40,000 (advance for future work)',
                        '',
                        'STEP 3: Virtual Wallet Updates',
                        '• Project A virtual balance increases by Rs. 60,000',
                        '• Project B virtual balance increases by Rs. 40,000',
                        '• System maintains record of allocation with invoice generation',
                        '',
                        'STEP 4: Automatic Settlement Check',
                        '• System checks if any project has outstanding loans',
                        '• If Project A owed Rs. 20,000 to Project C, it gets auto-settled',
                        '• Project A net balance becomes Rs. 40,000 (60,000 - 20,000)',
                        '• Project C loan receivable reduces by Rs. 20,000'
                    ];
                    
                    allocationSteps.forEach(line => {
                        if (line === '') {
                            y += 3;
                        } else if (line.startsWith('STEP')) {
                            doc.setFontSize(11);
                            doc.setTextColor(14, 165, 233);
                            doc.text(line, 20, y);
                            y += 7;
                        } else if (line.startsWith('•')) {
                            doc.setFontSize(9);
                            doc.setTextColor(51, 65, 85);
                            doc.text(line, 25, y);
                            y += 5;
                        } else if (line.startsWith('  -')) {
                            doc.setFontSize(9);
                            doc.setTextColor(75, 85, 99);
                            doc.text(line, 30, y);
                            y += 5;
                        } else {
                            doc.setFontSize(10);
                            doc.setTextColor(51, 65, 85);
                            doc.text(line, 20, y);
                            y += 6;
                        }
                    });
                    
                    // ===== PAGE 5: CROSS-PROJECT EXPENSES =====
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Cross-Project Expenses & Loans', 20, y);
                    y += 12;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(245, 158, 11);
                    doc.text('Real-World Scenario:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    const scenarioText = [
                        'SCENARIO: Buying tiles for Project C using Project A funds',
                        '',
                        'SITUATION:',
                        '• Project A has Rs. 50,000 virtual balance',
                        '• Project C has Rs. 0 virtual balance (no recent payments)',
                        '• Need to buy tiles worth Rs. 15,000 for Project C',
                        '• Only option is to use Project A funds',
                        '',
                        'SYSTEM PROCESS:',
                        '',
                        '1. RECORD CROSS-PROJECT EXPENSE',
                        '   • Beneficiary Project: Project C (who benefits)',
                        '   • Expense Amount: Rs. 15,000',
                        '   • Payment Source: Project A (who pays)',
                        '   • Description: "Tiles for Project C bathroom"',
                        '',
                        '2. AUTOMATIC LOAN CREATION',
                        '   • Project A virtual balance: Rs. 50,000 → Rs. 35,000',
                        '   • Project A loans given: Rs. 0 → Rs. 15,000',
                        '   • Project C loans received: Rs. 0 → Rs. 15,000',
                        '   • Project C gets the materials but owes money to Project A',
                        '',
                        '3. SETTLEMENT WHEN PROJECT C GETS PAYMENT',
                        '   • Client pays Rs. 30,000 for Project C',
                        '   • System auto-settles Rs. 15,000 loan to Project A',
                        '   • Project C virtual balance: Rs. 15,000 (30,000 - 15,000)',
                        '   • Project A loans given: Rs. 15,000 → Rs. 0',
                        '   • Project A virtual balance: Rs. 35,000 → Rs. 50,000'
                    ];
                    
                    scenarioText.forEach(line => {
                        if (line === '') {
                            y += 3;
                        } else if (line.startsWith('SCENARIO:') || line.startsWith('SITUATION:') || line.startsWith('SYSTEM PROCESS:')) {
                            doc.setFontSize(11);
                            doc.setTextColor(245, 158, 11);
                            doc.text(line, 20, y);
                            y += 7;
                        } else if (line.match(/^\\d+\\./)) {
                            doc.setFontSize(10);
                            doc.setTextColor(14, 165, 233);
                            doc.text(line, 20, y);
                            y += 6;
                        } else if (line.startsWith('•')) {
                            doc.setFontSize(9);
                            doc.setTextColor(51, 65, 85);
                            doc.text(line, 25, y);
                            y += 5;
                        } else if (line.startsWith('   •')) {
                            doc.setFontSize(9);
                            doc.setTextColor(75, 85, 99);
                            doc.text(line, 30, y);
                            y += 5;
                        } else {
                            doc.setFontSize(10);
                            doc.setTextColor(51, 65, 85);
                            doc.text(line, 20, y);
                            y += 6;
                        }
                    });
                    
                    // ===== PAGE 6: INVOICE SYSTEM =====
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Invoice & Documentation System', 20, y);
                    y += 12;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(16, 185, 129);
                    doc.text('Available Invoice Types:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    const invoiceTypes = [
                        '1. PAYMENT ALLOCATION INVOICES',
                        '   • Generated for each multi-project payment received',
                        '   • Shows how payment was distributed across projects',
                        '   • Includes client details, payment method, allocation breakdown',
                        '',
                        '2. CROSS-PROJECT EXPENSE INVOICES',
                        '   • Generated for expenses paid by one project for another',
                        '   • Shows loan creation details and payment sources',
                        '   • Tracks which project benefited and which project paid',
                        '',
                        '3. LOAN SETTLEMENT INVOICES',
                        '   • Generated when loans between projects are repaid',
                        '   • Shows settlement amount, method, and remaining balance',
                        '   • Maintains complete repayment history',
                        '',
                        '4. UNALLOCATED FUND INVOICES',
                        '   • Generated for payments not yet assigned to projects',
                        '   • Serves as reminder for proper fund allocation',
                        '   • Helps maintain accounting accuracy',
                        '',
                        '5. COMPLETE FUND MANAGEMENT REPORT',
                        '   • Comprehensive report covering all fund activities',
                        '   • Project-wise fund summaries and transaction histories',
                        '   • Overall system balance and reconciliation status',
                        '',
                        '6. PROJECT FUND STATUS REPORTS',
                        '   • Individual project financial summary',
                        '   • Virtual wallet status, loans, and allocations',
                        '   • Project-specific transaction history'
                    ];
                    
                    invoiceTypes.forEach(line => {
                        if (line === '') {
                            y += 3;
                        } else if (line.match(/^\\d+\\./)) {
                            doc.setFontSize(10);
                            doc.setTextColor(16, 185, 129);
                            doc.text(line, 20, y);
                            y += 6;
                        } else if (line.startsWith('   •')) {
                            doc.setFontSize(9);
                            doc.setTextColor(75, 85, 99);
                            doc.text(line, 25, y);
                            y += 5;
                        } else {
                            doc.setFontSize(10);
                            doc.setTextColor(51, 65, 85);
                            doc.text(line, 20, y);
                            y += 6;
                        }
                    });
                    
                    // ===== PAGE 7: SYSTEM BENEFITS =====
                    doc.addPage();
                    y = 20;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(14, 165, 233);
                    doc.text('System Benefits & Features', 20, y);
                    y += 12;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(16, 185, 129);
                    doc.text('Key Benefits:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(51, 65, 85);
                    const benefits = [
                        '✓ ACCURATE PROJECT ACCOUNTING',
                        '  • Each project shows true financial position',
                        '  • Clear separation of project funds despite single bank account',
                        '  • Real-time balance updates with every transaction',
                        '',
                        '✓ AUTOMATED LOAN MANAGEMENT',
                        '  • Automatic loan creation for cross-project expenses',
                        '  • Auto-settlement when borrower projects receive payments',
                        '  • Complete loan history and repayment tracking',
                        '',
                        '✓ COMPREHENSIVE AUDIT TRAIL',
                        '  • Every fund movement recorded with timestamps',
                        '  • Complete transaction history for all projects',
                        '  • Invoice generation for all fund transfers',
                        '',
                        '✓ FINANCIAL TRANSPARENCY',
                        '  • Clear visibility into inter-project financial relationships',
                        '  • Easy identification of project profitability',
                        '  • Accurate cost attribution and billing',
                        '',
                        '✓ SIMPLIFIED OPERATIONS',
                        '  • Single bank account for all projects',
                        '  • Automated calculations and settlements',
                        '  • Reduced manual tracking and errors',
                        '',
                        '✓ PROFESSIONAL DOCUMENTATION',
                        '  • Multiple invoice types for different scenarios',
                        '  • Comprehensive reports for stakeholders',
                        '  • Audit-ready financial records'
                    ];
                    
                    benefits.forEach(line => {
                        if (line === '') {
                            y += 3;
                        } else if (line.startsWith('✓')) {
                            doc.setFontSize(10);
                            doc.setTextColor(16, 185, 129);
                            doc.text(line, 20, y);
                            y += 6;
                        } else if (line.startsWith('  •')) {
                            doc.setFontSize(9);
                            doc.setTextColor(75, 85, 99);
                            doc.text(line, 25, y);
                            y += 5;
                        } else {
                            doc.setFontSize(10);
                            doc.setTextColor(51, 65, 85);
                            doc.text(line, 20, y);
                            y += 6;
                        }
                    });
                    
                    // Footer on all pages
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text('Maviya Constructions - Fund Management Understanding Guide', 20, 290);
                        doc.text(`Page ${i} of ${pageCount}`, 190, 290, { align: 'right' });
                    }
                    
                    // Save
                    const fileName = `Maviya_Constructions_Fund_Management_Understanding_Guide_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    this.showToast('Fund management understanding guide downloaded!', 'success');
                    
                } catch (error) {
                    console.error('Error generating fund understanding guide:', error);
                    this.showToast('Error generating guide: ' + error.message, 'error');
                }
            },

            async generateCompleteFundReport() {
                try {
                    this.showToast('Generating complete fund management report...', 'info');
                    
                    // Load jsPDF
                    if (!window.jspdf) {
                        throw new Error('jsPDF library not loaded');
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Get all fund data
                    const overallStatus = await FundManagement.getOverallFundStatus();
                    const allPayments = await Storage.clientPayments.getAll();
                    const allAllocations = await Storage.paymentAllocations.getAll();
                    
                    // Get payments that have allocations (both multi-project and auto-allocated)
                    const allocatedPaymentIds = [...new Set(allAllocations.map(a => a.paymentId))];
                    const allocatedPayments = allPayments.filter(p => 
                        p.isMultiProject || allocatedPaymentIds.includes(p.id)
                    );
                    const allTransactions = await Storage.crossProjectTransactions.getAll();
                    const allSettlements = await Storage.settlementRecords.getAll();
                    
                    let y = 20;
                    
                    // ===== PAGE 1: COVER & OVERALL STATUS =====
                    // Header
                    doc.setFontSize(24);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Maviya Constructions', 105, y, { align: 'center' });
                    y += 12;
                    
                    doc.setFontSize(18);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Complete Fund Management Report', 105, y, { align: 'center' });
                    y += 15;
                    
                    // Report Date Box
                    doc.setFillColor(14, 165, 233);
                    doc.roundedRect(20, y, 170, 12, 3, 3, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, 105, y + 8, { align: 'center' });
                    y += 20;
                    
                    // Overall Fund Status
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(20, y, 170, 40, 3, 3, 'F');
                    y += 8;
                    doc.setFontSize(14);
                    doc.setTextColor(14, 165, 233);
                    doc.text('Overall Fund Status', 105, y, { align: 'center' });
                    y += 12;
                    
                    doc.setFontSize(11);
                    doc.setTextColor(51, 65, 85);
                    const col1 = 35, col2 = 105;
                    doc.text('Total Virtual Balance:', col1, y);
                    doc.text(`Rs. ${this.formatNumber(overallStatus.totalVirtualBalance)}`, col1 + 60, y);
                    doc.text('Active Projects:', col2, y);
                    doc.text(`${overallStatus.projectSummaries.length}`, col2 + 50, y);
                    y += 8;
                    doc.text('Total Active Loans:', col1, y);
                    doc.text(`Rs. ${this.formatNumber(overallStatus.totalActiveLoans)}`, col1 + 60, y);
                    doc.text('System Status:', col2, y);
                    if (overallStatus.isBalanced) {
                        doc.setTextColor(16, 185, 129);
                        doc.text('✓ Balanced', col2 + 50, y);
                    } else {
                        doc.setTextColor(239, 68, 68);
                        doc.text('⚠ Unbalanced', col2 + 50, y);
                    }
                    y += 20;
                    
                    // Project Summary Table
                    doc.setFontSize(12);
                    doc.setTextColor(51, 65, 85);
                    doc.text('Project-wise Fund Summary', 20, y);
                    y += 8;
                    
                    const projectSummaryData = overallStatus.projectSummaries.map(project => [
                        project.projectName,
                        `Rs. ${this.formatNumber(project.virtualBalance)}`,
                        `Rs. ${this.formatNumber(project.activeLoansGiven)}`,
                        `Rs. ${this.formatNumber(project.activeLoansReceived)}`,
                        `Rs. ${this.formatNumber(project.netAvailableBalance)}`
                    ]);
                    
                    doc.autoTable({
                        startY: y,
                        head: [['Project', 'Virtual Balance', 'Loans Given', 'Loans Received', 'Net Available']],
                        body: projectSummaryData,
                        theme: 'grid',
                        headStyles: { fillColor: [14, 165, 233] },
                        margin: { left: 20, right: 20 },
                        styles: { fontSize: 8 }
                    });
                    
                    // ===== PAGE 2: PAYMENT ALLOCATIONS =====
                    if (allocatedPayments.length > 0) {
                        doc.addPage();
                        y = 20;
                        doc.setFontSize(16);
                        doc.setTextColor(16, 185, 129);
                        doc.text('Payment Allocations (Multi-Project & Auto-Allocated)', 20, y);
                        y += 10;
                        
                        // Sort by date (newest first)
                        allocatedPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        for (const payment of allocatedPayments) {
                            const allocations = await Storage.paymentAllocations.getByPayment(payment.id);
                            const paymentType = payment.isMultiProject ? 'Multi-Project' : 'Auto-Allocated';
                            
                            // Payment header
                            doc.setFontSize(12);
                            doc.setTextColor(51, 65, 85);
                            doc.text(`Payment: Rs. ${this.formatNumber(payment.amount)} from ${payment.from}`, 20, y);
                            doc.text(`Date: ${this.formatDate(payment.date)}`, 120, y);
                            y += 6;
                            doc.text(`Method: ${payment.method}`, 20, y);
                            doc.text(`Type: ${paymentType}`, 120, y);
                            y += 6;
                            doc.text(`Received by: ${payment.receivedBy}`, 20, y);
                            y += 10;
                            
                            // Allocation details
                            const allocationData = await Promise.all(allocations.map(async (alloc) => {
                                const project = await Storage.projects.getById(alloc.projectId);
                                return [
                                    project ? project.name : 'Unknown',
                                    `Rs. ${this.formatNumber(alloc.amount)}`,
                                    alloc.description || 'Payment allocation'
                                ];
                            }));
                            
                            doc.autoTable({
                                startY: y,
                                head: [['Project', 'Amount', 'Description']],
                                body: allocationData,
                                theme: 'striped',
                                headStyles: { fillColor: [16, 185, 129] },
                                margin: { left: 30, right: 20 },
                                styles: { fontSize: 9 }
                            });
                            
                            y = doc.lastAutoTable.finalY + 15;
                            
                            // Check if we need a new page
                            if (y > 250) {
                                doc.addPage();
                                y = 20;
                            }
                        }
                    }
                    
                    // ===== PAGE 3: ACTIVE INTER-PROJECT LOANS =====
                    const activeLoans = allTransactions.filter(t => t.status === 'active');
                    if (activeLoans.length > 0) {
                        doc.addPage();
                        y = 20;
                        doc.setFontSize(16);
                        doc.setTextColor(245, 158, 11);
                        doc.text('Active Inter-Project Loans', 20, y);
                        y += 10;
                        
                        const loanData = await Promise.all(activeLoans.map(async (loan) => {
                            const lenderProject = await Storage.projects.getById(loan.lenderProjectId);
                            const borrowerProject = await Storage.projects.getById(loan.borrowerProjectId);
                            const balance = loan.amount - (loan.settlementAmount || 0);
                            
                            return [
                                lenderProject ? lenderProject.name : 'Unknown',
                                borrowerProject ? borrowerProject.name : 'Unknown',
                                this.formatDate(loan.date),
                                `Rs. ${this.formatNumber(loan.amount)}`,
                                `Rs. ${this.formatNumber(loan.settlementAmount || 0)}`,
                                `Rs. ${this.formatNumber(balance)}`,
                                loan.description
                            ];
                        }));
                        
                        doc.autoTable({
                            startY: y,
                            head: [['Lender', 'Borrower', 'Date', 'Original', 'Settled', 'Outstanding', 'Description']],
                            body: loanData,
                            theme: 'striped',
                            headStyles: { fillColor: [245, 158, 11] },
                            margin: { left: 20, right: 20 },
                            styles: { fontSize: 8 }
                        });
                    }
                    
                    // ===== PAGE 4: SETTLEMENT HISTORY =====
                    if (allSettlements.length > 0) {
                        doc.addPage();
                        y = 20;
                        doc.setFontSize(16);
                        doc.setTextColor(16, 185, 129);
                        doc.text('Loan Settlement History', 20, y);
                        y += 10;
                        
                        // Sort by date (newest first)
                        allSettlements.sort((a, b) => new Date(b.settlementDate) - new Date(a.settlementDate));
                        
                        const settlementData = await Promise.all(allSettlements.map(async (settlement) => {
                            const lenderProject = await Storage.projects.getById(settlement.lenderProjectId);
                            const borrowerProject = await Storage.projects.getById(settlement.borrowerProjectId);
                            
                            return [
                                this.formatDate(settlement.settlementDate),
                                borrowerProject ? borrowerProject.name : 'Unknown',
                                lenderProject ? lenderProject.name : 'Unknown',
                                `Rs. ${this.formatNumber(settlement.settlementAmount)}`,
                                settlement.settlementType === 'auto' ? 'Automatic' : 'Manual'
                            ];
                        }));
                        
                        doc.autoTable({
                            startY: y,
                            head: [['Date', 'From (Borrower)', 'To (Lender)', 'Amount', 'Type']],
                            body: settlementData,
                            theme: 'striped',
                            headStyles: { fillColor: [16, 185, 129] },
                            margin: { left: 20, right: 20 },
                            styles: { fontSize: 9 }
                        });
                    }
                    
                    // ===== PAGE 5: DETAILED PROJECT FUND STATUS =====
                    for (const projectSummary of overallStatus.projectSummaries) {
                        doc.addPage();
                        y = 20;
                        
                        // Project header
                        doc.setFontSize(16);
                        doc.setTextColor(14, 165, 233);
                        doc.text(`Project: ${projectSummary.projectName}`, 20, y);
                        y += 15;
                        
                        // Project fund metrics
                        doc.setFillColor(241, 245, 249);
                        doc.roundedRect(20, y, 170, 30, 3, 3, 'F');
                        y += 8;
                        doc.setFontSize(10);
                        doc.setTextColor(51, 65, 85);
                        
                        doc.text('Virtual Balance:', 30, y);
                        doc.text(`Rs. ${this.formatNumber(projectSummary.virtualBalance)}`, 80, y);
                        doc.text('Advance Received:', 110, y);
                        doc.text(`Rs. ${this.formatNumber(projectSummary.advanceReceived)}`, 160, y);
                        y += 7;
                        doc.text('Loans Given:', 30, y);
                        doc.text(`Rs. ${this.formatNumber(projectSummary.activeLoansGiven)}`, 80, y);
                        doc.text('Loans Received:', 110, y);
                        doc.text(`Rs. ${this.formatNumber(projectSummary.activeLoansReceived)}`, 160, y);
                        y += 7;
                        doc.text('Net Available:', 30, y);
                        if (projectSummary.netAvailableBalance >= 0) {
                            doc.setTextColor(16, 185, 129);
                        } else {
                            doc.setTextColor(239, 68, 68);
                        }
                        doc.text(`Rs. ${this.formatNumber(projectSummary.netAvailableBalance)}`, 80, y);
                        y += 15;
                        
                        // Project-specific allocations
                        const projectAllocations = allAllocations.filter(a => a.projectId === projectSummary.projectId);
                        if (projectAllocations.length > 0) {
                            doc.setFontSize(12);
                            doc.setTextColor(16, 185, 129);
                            doc.text('Payment Allocations', 20, y);
                            y += 8;
                            
                            const allocData = await Promise.all(projectAllocations.map(async (alloc) => {
                                const payment = await Storage.clientPayments.getById(alloc.paymentId);
                                return [
                                    this.formatDate(alloc.date),
                                    payment ? payment.from : 'N/A',
                                    `Rs. ${this.formatNumber(alloc.amount)}`,
                                    alloc.description || 'Payment allocation'
                                ];
                            }));
                            
                            doc.autoTable({
                                startY: y,
                                head: [['Date', 'From', 'Amount', 'Description']],
                                body: allocData,
                                theme: 'striped',
                                headStyles: { fillColor: [16, 185, 129] },
                                margin: { left: 20, right: 20 },
                                styles: { fontSize: 8 }
                            });
                            
                            y = doc.lastAutoTable.finalY + 10;
                        }
                        
                        // Project loans given
                        const projectLoansGiven = activeLoans.filter(l => l.lenderProjectId === projectSummary.projectId);
                        if (projectLoansGiven.length > 0) {
                            doc.setFontSize(12);
                            doc.setTextColor(245, 158, 11);
                            doc.text('Loans Given', 20, y);
                            y += 8;
                            
                            const loanGivenData = await Promise.all(projectLoansGiven.map(async (loan) => {
                                const borrowerProject = await Storage.projects.getById(loan.borrowerProjectId);
                                const balance = loan.amount - (loan.settlementAmount || 0);
                                return [
                                    borrowerProject ? borrowerProject.name : 'Unknown',
                                    this.formatDate(loan.date),
                                    `Rs. ${this.formatNumber(balance)}`,
                                    loan.description
                                ];
                            }));
                            
                            doc.autoTable({
                                startY: y,
                                head: [['To Project', 'Date', 'Outstanding', 'Description']],
                                body: loanGivenData,
                                theme: 'striped',
                                headStyles: { fillColor: [245, 158, 11] },
                                margin: { left: 20, right: 20 },
                                styles: { fontSize: 8 }
                            });
                            
                            y = doc.lastAutoTable.finalY + 10;
                        }
                        
                        // Project loans received
                        const projectLoansReceived = activeLoans.filter(l => l.borrowerProjectId === projectSummary.projectId);
                        if (projectLoansReceived.length > 0) {
                            doc.setFontSize(12);
                            doc.setTextColor(239, 68, 68);
                            doc.text('Loans Received', 20, y);
                            y += 8;
                            
                            const loanReceivedData = await Promise.all(projectLoansReceived.map(async (loan) => {
                                const lenderProject = await Storage.projects.getById(loan.lenderProjectId);
                                const balance = loan.amount - (loan.settlementAmount || 0);
                                return [
                                    lenderProject ? lenderProject.name : 'Unknown',
                                    this.formatDate(loan.date),
                                    `Rs. ${this.formatNumber(balance)}`,
                                    loan.description
                                ];
                            }));
                            
                            doc.autoTable({
                                startY: y,
                                head: [['From Project', 'Date', 'Outstanding', 'Description']],
                                body: loanReceivedData,
                                theme: 'striped',
                                headStyles: { fillColor: [239, 68, 68] },
                                margin: { left: 20, right: 20 },
                                styles: { fontSize: 8 }
                            });
                        }
                    }
                    
                    // Footer on all pages
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text('Maviya Constructions - Complete Fund Management Report', 20, 290);
                        doc.text(`Generated: ${new Date().toLocaleString('en-IN')}  |  Page ${i} of ${pageCount}`, 190, 290, { align: 'right' });
                    }
                    
                    // Save
                    const fileName = `Maviya_Constructions_Complete_Fund_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    this.showToast('Complete fund management report downloaded!', 'success');
                    
                } catch (error) {
                    console.error('Error generating complete fund report:', error);
                    this.showToast('Error generating report: ' + error.message, 'error');
                }
            },

            showToast(message, type = 'info') {
                // Simple toast implementation
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                    type === 'success' ? 'bg-emerald-500' : 
                    type === 'error' ? 'bg-rose-500' : 'bg-sky-500'
                }`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        };

        window.FundsApp = FundsApp;
    </script>
</body>
</html>